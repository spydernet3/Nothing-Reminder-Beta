<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nothing Reminder</title>
    <link rel="icon" type="image/png" href="assets/icon.png" />
    <link rel="manifest" href="manifest.json" />
    <style>
      html, body {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      }

      :root {
        --bg: #ffffff;
        --text: #000000;
        --muted: #666;
        --accent: #4CAF50;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        background: var(--bg);
        color: var(--text);
      }
      .sidebar {
        width: 220px;
        background: #666;
        color: #fff;
        position: fixed;
        height: 100%;
        left: 0;
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 8px;
        transition: left 0s;
      }
      .profile {
        display:flex;
        align-items:center;
        gap:21px;
        margin-top:8px;
        margin-bottom:8px;
      }
      .menu-btn, .icon-btn, .add-btn {
        display:block;
        width:100%;
        padding:10px;
        border: none;
        background:#888;
        font-style: Italic;
        color:#fff;
        border-radius:6px;
        cursor:pointer;
        text-align:left;
        font-size:15px;
        transition: left 0s;
      }
      .menu-btn:hover, .icon-btn:hover, .add-btn:hover { background:#aaa; }
      .main {
        margin-left: 220px;
        padding: 20px;
        min-height: 100vh;
        transition: margin-left 0s;
      }
      .page.hidden { display:none; }
      .toggle-btn {
        position: absolute;
        left: 5px; /* Adjusted to show partial icon */
        top: 6px;
        padding:6px 8px;
        border-radius:8px;
        border:none;
        background:transparent;
        cursor:pointer;
        transition: left 0s;
        z-index: 10;
        width: 22px; /* Make it smaller to show partial icon */
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .list { list-style:none; padding:0; margin:0 0 12px 0; }
      .list li {
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:8px;
        border-radius:6px;
        margin-bottom:8px;
        background: rgba(0,0,0,0.03);
        transition: left 0s;
      }
      .item-left { display:flex; flex-direction:column; gap:4px; }
      .badge { background:#eee; padding:4px 8px; border-radius:12px;
        font-size:12px; }
      .form {
        margin-top: 0;
        padding: 12px;
        border-radius: 8px;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 520px;
        overflow: hidden;
        transition: max-height 0s ease, padding 0s ease;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        transition: left 0s;
      }
      .form.visible {
        max-height: 500px;
        padding-top: 12px;
        padding-bottom: 12px;
      }
      .form label {
        display:flex;
        flex-direction:column;
        font-size:13px;
        gap:6px;
        transition: left 0s;
      }
      .form input[type="text"], .form input[type="date"], .form textarea, .form select {
        padding:8px;
        border-radius:6px;
        border:1px solid #ccc;
        transition: left 0s;
      }
      .form-actions {
        display:flex;
        gap:8px;
        margin-top:6px;
        transition: left 0s;
      }
      .primary {
        background: var(--accent);
        color: #fff;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        cursor:pointer;
      }
      .secondary {
        background:#ddd;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        cursor:pointer;
      }
      .icon-small {
        background:transparent;
        border:none;
        cursor:pointer;
        margin-left:8px;
        font-size:16px;
      }
      .add-area {
        margin-top: 8px;
        max-width: 520px;
      }
      .dark {
        --bg: #121212;
        --text: #f1f1f1;
      }
      .dark .main { background:#151515; color:var(--text); }
      .dark .form { background: #232323; }
      .dark .menu-btn, .dark .icon-btn { background:#333; color:var(--text); }

      /* Settings panel styles */
      .settings-panel {
        display: none;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      .settings-panel.visible { display: flex; }

      /* Consistent button styling for all sections */
      #showAddFormBtn, #homeRemindersToggle, #showAddNoteBtn, #viewNotesToggle, #homeNotesToggle,
      #homeBudgetsToggle, #homeCheckToggle, #showAddBudgetBtn,#viewbudgetToggle, #showAddCheckBtn,
      #viewCheckToggle, #homeOverviewToggle, #viewRemindersToggle,#moonPhaseToggle, #sunBtn,
      #goldRateToggle, #weatherToggle, #monthlyCalendarToggle,#calculatorToggle, #viewHistoryToggle {
        position: relative;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: left 0s;
        padding: 10px;
        border: none;
        background: #888;
        color: #fff;
        border-radius: 6px;
        text-align: left;
      }

      #showAddFormBtn:hover, #homeRemindersToggle:hover, #showAddNoteBtn:hover, #viewNotesToggle:hover,
      #homeNotesToggle:hover, #homeBudgetsToggle:hover, #homeCheckToggle:hover, #showAddBudgetBtn:hover,
      #viewbudgetToggle:hover, #showAddCheckBtn:hover,#viewCheckToggle:hover, #viewRemindersToggle:hover {
        background: #aaa;
      }

      #showAddFormBtn.open .arrow, #homeRemindersToggle.open .arrow,#showAddNoteBtn.open .arrow,
      #viewNotesToggle.open .arrow, #homeNotesToggle.open .arrow,#homeBudgetsToggle.open .arrow,
      #homeCheckToggle.open .arrow, #showAddBudgetBtn.open .arrow,#viewbudgetToggle.open .arrow,
      #showAddCheckBtn.open .arrow, #viewCheckToggle.open .arrow,#viewRemindersToggle.open .arrow {
        transform: rotate(180deg);
        transition: left 0s;
      }

      /* Add this to your existing <style> block */
      .calendar-day {
          padding: 8px 4px;
          border: 1px solid #eee;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: default;
      }
      .calendar-day.today {
          background: var(--accent);
          color: white;
          font-weight: bold;
          border-radius: 50%;
      }
      .calendar-day.spacer {
          background: transparent;
          border: none;
      }
      .calculator-mode.hidden { display: none; }
      .normal-btn {
          padding: 10px;
          font-size: 16px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
      }
      .normal-btn.primary { background: #e0e0e0; color: #000; }
      .normal-btn.secondary { background: #ccc; color: #000; }

      /* Scrollable lists */
      .scrollable-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
      }

      /* Scrollbar styling */
      .scrollable-list::-webkit-scrollbar {
        width: 8px;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #555;
        border-radius: 4px;
      }

      /* Checklist status button */
      .status-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 8px;
        font-size: 12px;
      }

      /* Branding footer */
      .branding-footer {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: #666;
        text-align: center;
      }

      .branding-footer a {
        color: #666;
        text-decoration: none;
      }

      /* Notification Page Specific Styles */
      .notif-status-box {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #e0f7fa;
        border: 1px solid #b2ebf2;
      }
      .notif-status-box.denied {
        background: #ffebee;
        border: 1px solid #ffcdd2;
      }
      .notif-setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .notif-setting-item:last-child {
        border-bottom: none;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--accent);
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .sidebar {
        width: 220px;
        background: #666;
        color: #fff;
        position: fixed;
        height: 100%;
        left: 0;
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 8px;
        transition: left 0s;
        overflow-y: auto;
      }
      #storageBarContainer { position:relative; background:#333; border-radius:8px; height:16px; width:100%; overflow:visible; }
      #storageBar { background:linear-gradient(90deg,#4caf50,#8bc34a); border-radius:8px; height:100%; width:0%; transition:width 0.4s ease; }
      #storageEmoji { position:absolute; top:-5px; left:0; font-size:18px; z-index:5; pointer-events:none; transition:left 0.4s ease; }
      #viewStorageBtn { flex-direction:column; gap:6px; align-items:flex-start; }
      /* Compact BMI layout */
      #bmiCalculator {
        max-width: 350px;
        margin: 10px auto;
      }
      
      .bmi-input-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 8px; /* reduced from default 20+px */
      }
      
      #bmiCalculator label {
        font-weight: 600;
        margin-bottom: 3px;
      }
      
      #bmiCalculator input {
        padding: 6px 8px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      
      #calcBMIButton {
        margin-top: 6px;
        padding: 8px 122px;
        border: none;
        background: #4caf50;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      
      #calcBMIButton:hover {
        background: #43a047;
      }
      #moonPhaseToggle {
        background: #888;
        color: #fff;
        font-weight: 600;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-top: 8px;
      }
      
      #moonPhaseContainer {
        background: #ffffff;
        color: black;
        padding: 10px 12px;
        border-radius: 8px;
        margin-top: 5px;
        display: none;
      }
      
      #moonPhaseContainer.visible { display: block; }
      
      .moon-day {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
        padding: 5px 6px;
        border-bottom: 1px solid #444;
      }
      
      .moon-day:last-child { border: none; }
      #sunBtn {
        background:#888;
        color:#fff;
        padding:10px;
        width:100%;
        border:none;
        border-radius:6px;
        margin-top:8px;
        font-weight:600;
      }
      
      #sunBox {
        background:white;
        padding:10px;
        border-radius:8px;
        margin-top:6px;
        color:black;
        display:none;
      }
      
      #sunBox.visible {
        display:block;
      }
      
      #sunCity, #latInput, #lngInput {
        width:100%;
        padding:8px;
        border-radius:6px;
        border:1px solid #444;
        margin-top:5px;
      }
     
      .form.visible {
          max-height: 5000px;   /* LARGE SAFE VALUE */
          overflow: visible;
          padding-bottom: 10px; /* Extra bottom space for full visibility */
      }
      
      .gold-table-wrapper {
          overflow-x: auto;
          overflow-y: visible;
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      .gold-table-wrapper::-webkit-scrollbar {
          display: none;
      }
      #ebCalculator label {
      display: block;
      margin-bottom: 15px; /* controls spacing between each input */
      }
      #installBtn {
      position: fixed;
      top: 10px;
      right: 12px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(6px);
      padding: 8px 14px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      color: black;
      font-weight: bold;
      font-size: 14px;
      z-index: 9999;
      display: none;
      cursor: pointer;
    }
    
    #installBtn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    </style>
  </head>
  <body>
    <button id="installBtn" onclick="installApp()">
    INSTALL APP üêí
    </button>
    <div id="sidebar" class="sidebar">
      <div class="profile">
        <img
          id="profilePhoto"
          src="https://via.placeholder.com/40"
          alt="Profile"
          width="45"
          height="45"
          style="border-radius:50%;object-fit:cover;cursor:pointer;"
          onclick="document.getElementById('photoUpload').click()"
        />
        <h3 id="profileName">üë§ User</h3>
      </div>
      <input
        id="photoUpload"
        type="file"
        accept="image/*"
        style="display:none;"
      />

      <button class="menu-btn" data-page="home">üè† Home</button>
      <button class="menu-btn" data-page="reminders">‚è∞ Reminders</button>
      <button class="menu-btn" data-page="notes">üìù Notes</button>
      <button class="menu-btn" data-page="budget">üí∞ Budget Tracker</button>
      <button class="menu-btn" data-page="Check">‚úí Check List</button>
      <button class="menu-btn" data-page="utilities">üõ†Ô∏è Utilities</button>
      <button class="menu-btn" data-page="trash">üóëÔ∏è Trash Bin</button>
      <button class="menu-btn" data-page="other">üé≤ More Apps</button>

      <div id="settingsContainer" style="margin-top:auto;">
        <button id="settingsBtn" class="icon-btn" aria-expanded="false">
          ‚öôÔ∏è Settings ‚ñº
        </button>
        <div id="settingsPanel" class="settings-panel" aria-hidden="true">
          <button class="menu-btn" id="editNameBtn">‚úèÔ∏è Edit Name</button>
          <button class="icon-btn" id="darkModeBtn">üåô Dark Mode</button>
          <button
            class="menu-btn"
            data-page="notifications"
            id="notificationBtn"
          >
            üîî Notification Settings
          </button>

          <button class="menu-btn" data-page="terms">
            üí¢ Terms & Conditions
          </button>
          <button class="menu-btn" data-page="how">üßë‚Äçüè´ How to Use</button>
        <!-- üíæ Storage Usage -->
        <button id="viewStorageBtn" class="menu-btn" style="flex-direction:column;align-items:flex-start;">
          <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
            <span>üíæ</span>
            <span id="storageText" style="font-size:13px;opacity:0.9;">Calculating...</span>
          </div>
          <div id="storageBarContainer" style="background:#333;border-radius:8px;height:16px;width:100%;margin-top:8px;overflow:visible;position:relative;">
            <div id="storageBar" style="background:linear-gradient(90deg,#4caf50,#8bc34a);border-radius:8px;height:100%;width:0%;transition:width 0.4s ease;"></div>
            <span id="storageEmoji" style="position:absolute;top:-5px;left:0;font-size:18px;z-index:5;pointer-events:none;transition:left 0.4s ease;">üôà</span>
          </div>
        </button>
        </div>
      </div>
    </div>

    <div id="main" class="main">
      <button id="toggleBtn" class="toggle-btn">üêµ</button>

      <div id="home" class="page">
        <h2>Home</h2>
        <div class="add-area">
          <button
            id="homeRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            ‚ö†Ô∏è REMINDERS <span class="arrow">‚ñº</span>
          </button>
          <div id="homeRemindersContainer" class="form"></div>
        </div>
        <div class="add-area">
          <button id="homeNotesToggle" class="add-btn" aria-expanded="false">
            üìù NOTES <span class="arrow">‚ñº</span>
          </button>
          <div id="homeNotesContainer" class="form" aria-hidden="true"></div>
        </div>
        <div class="add-area">
          <button id="homeBudgetsToggle" class="add-btn" aria-expanded="false">
            üí∞ BUDGET OVERVIEW <span class="arrow">‚ñº</span>
          </button>
          <div id="homeBudgetsContainer" class="form" aria-hidden="true"></div>
        </div>

        <div class="add-area">
          <button id="homeCheckToggle" class="add-btn" aria-expanded="false">
            ‚úí CHECK LIST <span class="arrow">‚ñº</span>
          </button>
          <div id="homeCheckContainer" class="form" aria-hidden="true"></div>
        </div>
        <div class="add-area">
          <button id="homeOverviewToggle" class="add-btn" aria-expanded="false">
            üìä REMINDERS OVERVIEW <span class="arrow">‚ñº</span>
          </button>

          <div id="homeOverviewContainer" class="form" aria-hidden="true">
            <table style="width:100%; border-collapse: collapse; text-align:center;">
              <tr style="font-weight:600;">
                <td>TITLE</td>
                <td>ACTIVE</td>
                <td>INACTIVE</td>
              </tr>

              <tr>
                <td>Reminders</td>
                <td id="activeRemindersCount">0</td>
                <td id="inactiveRemindersCount">0</td>
              </tr>

              <tr>
                <td>Checklists</td>
                <td id="activeChecklistsCount">0</td>
                <td id="inactiveChecklistsCount">0</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="branding-footer">
          <a href="https://github.com/spydernet3" target="_blank"
            >By Spydernet</a
          >
        </div>
      </div>

      <div id="reminders" class="page hidden">
        <h2>Reminders</h2>
        <div class="add-area">
          <button id="showAddFormBtn" class="add-btn" aria-expanded="false">
            Ôºã ADD NEW REMINDER <span class="arrow">‚ñº</span>
          </button>
          <div id="reminderFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input id="reminderTitle" type="text" placeholder="Title"
            /></label>
            <label>Start date<input id="startDate" type="date" /></label>
            <label>End date<input id="endDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveReminderBtn" class="primary">Save</button>
              <button id="cancelReminderBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button
            id="viewRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            üëÄ VIEW REMINDERS <span class="arrow">‚ñº</span>
          </button>
          <ul id="reminderList" class="list scrollable-list form"></ul>
        </div>
      </div>

      <div id="notes" class="page hidden">
        <h2>üìù Notes</h2>
        <div class="add-area">
          <button id="showAddNoteBtn" class="add-btn" aria-expanded="false">
            Ôºã ADD NEW NOTE <span class="arrow">‚ñº</span>
          </button>
          <div id="noteFormContainer" class="form" aria-hidden="true">
            <label>
              Attach File
              <input
                id="noteFile"
                type="file"
                accept="image/*,.pdf,.doc,.docx,.mp3,.mp4"
              />
            </label>
            <label>
              Note<textarea
                id="noteText"
                rows="4"
                placeholder="Create a note here, use | to add a title and --- to separate columns for table format."
              ></textarea>
            </label>
            <label>
              Table Format<input type="checkbox" id="tableFormatCheckbox" />
              <span>Enable table format</span>
            </label>
            <div class="form-actions">
              <button id="saveNoteBtn" class="primary">Save</button>
              <button id="cancelNoteBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewNotesToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW NOTES <span class="arrow">‚ñº</span>
          </button>
          <ul id="noteList" class="list scrollable-list form"></ul>
        </div>
      </div>
      <div id="budget" class="page hidden">
        <h2>üí∞ Budget Tracker</h2>
        <div class="add-area">
          <button id="showAddBudgetBtn" class="add-btn" aria-expanded="false">
            Ôºã CREATE NEW BUDGET <span class="arrow">‚ñº</span>
          </button>
          <div id="budgetFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input
                id="budgetTitle"
                type="text"
                placeholder="Budget title"
            /></label>
            <label
              >Total Amount (‚Çπ)<input
                id="budgetAmount"
                type="number"
                placeholder="Total Amount"
            /></label>
            <label>Start Date<input id="budgetStartDate" type="date" /></label>
            <label>End Date<input id="budgetEndDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveBudgetBtn" class="primary">Save</button>
              <button id="cancelBudgetBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewbudgetToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW BUDGET OVERVIEW <span class="arrow">‚ñº</span>
          </button>
          <ul id="budgetList" class="list scrollable-list form"></ul>
        </div>
      </div>
      <div id="Check" class="page hidden">
        <h2>‚úí Check List</h2>
        <div class="add-area">
          <button id="showAddCheckBtn" class="add-btn" aria-expanded="false">
            Ôºã CREATE NEW CHECKLIST <span class="arrow">‚ñº</span>
          </button>
          <div id="checkFormContainer" class="form" aria-hidden="true">
            <label>
              Title<input
                id="checkTitle"
                type="text"
                placeholder="Checklist title"
              />
            </label>
            <label>
              Status<select id="checkStatus">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </label>
            <label>
              Items (one per line)<textarea
                id="checkItems"
                rows="4"
                placeholder="Item 1&#10;Item 2&#10;Item 3"
              ></textarea>
            </label>
            <div class="form-actions">
              <button id="saveCheckBtn" class="primary">Save</button>
              <button id="cancelCheckBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewCheckToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW CHECKLISTS <span class="arrow">‚ñº</span>
          </button>
          <ul id="checkList" class="list scrollable-list form"></ul>
        </div>
      </div>
      <div id="notifications" class="page hidden">
        <h2>üîî Notification Settings</h2>

        <div id="globalNotifStatus" class="notif-status-box">
          <h3>Browser Permission</h3>
          <p id="browserPermissionText"></p>
          <button
            id="requestPermissionBtn"
            class="primary"
            style="margin-top: 10px;"
          >
            Request / Check Permission
          </button>
        </div>

        <h3>Notification Categories</h3>
        <p style="font-size: 14px; opacity: 0.8;">
          Note: Category notifications only work if the browser permission above
          is # Granted #.
        </p>

        <div class="notif-setting-item">
          <span>‚è∞ Reminder Page Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleReminders" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üìù Notes Reminders </span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleNotes" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>‚úí Checklist Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleChecklist" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üí∞ Budget Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleBudget" />
            <span class="slider"></span>
          </label>
        </div>
        <div class="notif-setting-item">
          <span>üåô Moon Phase Alerts</span>
          <label class="toggle-switch">
          <input type="checkbox" id="toggleMoonPhase">
          <span class="slider"></span>
          </label>
       </div>
      </div>
      <div id="terms" class="page hidden">
        <h2>Privacy Policy!</h2>
        <ul>
          <h2>üìÇ Data We Colleted</h2>
          <ul>
          <p>
            App data are stored using local storage. Avoid data losses before
            formatting the device.
          </p>
          <p>Maximum 500MB allowed to store user datas in local storage.</p>
          <p>
            Datas are synced as much as possible while page load after it
            depends on your browser behaviour
          </p>
          <p>
            Import & Export and Sharing datas are not allowed for security
            reasons
          </p>
          </ul>
          <h2> üåê App Security</h2>
          <ul>
          <p>
            Codes are carefully reviewed by ChatGPT and other AI Models Checkout
            Overall Rating in GitHub Readme file
          </p>
          <p>Users were not asked for any other permissions other than Notification Permission.</p>
          </ul>
          <h2>üìû Contact Us</h2>
          <ul>
          <p>
            Would you like to contribute, check out here:
            <a href="https://github.com/spydernet3" target="_blank"
              >Spydernet Github ‚Ü†</a>
          </p>
          <p> Developer : mersalmgblog@gmail.com</p>
        </ul>
        <hr />
        <h3>Version Info!</h3>
        <ul>
          <p>Version 13.6.5</p>
          <p>Last Updated: 06-Dec-2025</p>
          <p>Project Mode: Open source</p>
          <p>App Size    : 7.0KB </p>
        </ul>
      </div>
      <div id="how" class="page hidden">
        <h3>Install App</h3>
        <hr />
        <ul>
          <li>
            By Pressing Add to Home Screen Button There You can see Install App
            to install page as PWA [Faster and unique icon compared to webpage] 
          </li>
          </ul>
          <h3>App Lock</h3>
        <hr />
        <ul>
          <li>
            By installing page as PWA you can use By Defauly App lock that contains your device
        </li>
        <li>
          By enabling App lock for Browswer also the way you can protect the data without intalling page as app
        </li>
        </ul>
        <h3>Reminder!</h3>
        <hr />
        <ul>
          <li>Go to the Reminders page</li>
          <li>Click + Add New Reminder</li>
          <li>Fill Title, Start Date, End Date</li>
          <li>Click Save</li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
          <li>
            Today & Tomorrow Due reminders will appeared on the Home page
            automatically.
          </li>
        </ul>

        <h3>Notes!</h3>
        <hr />
        <ul>
          <li>Go to the Notes page.</li>
          <li>Click + Add New Note.</li>
          <li>Write your note in the textarea.</li>
          <li>It supports file formats (Images, pdf, audio, video, docs).</li>
          <li>Click Save. IST date & time are added automatically.</li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
        </ul>

        <h3>Budget Tracker!</h3>
        <hr />
        <ul>
          <li>Go to the Budget Tracker page.</li>
          <li>Click + Add New Budget.</li>
          <li>That will showed Total Amount/Remaining Days</li>
          <li>
          <li>That will shows Cost per day How much you need to spend</li>
          <li> Add Expenses and track everything </li>
          <li>
            At Budget reminder it will reminders your spend limit every day
          </li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
        </ul>

        <h3>Profile!</h3>
        <hr />
        <ul>
          <li>Click the profile picture to upload a new image.</li>
          <li>Click Edit Name to update the username now under Settings.</li>
        </ul>
        <h3>Checklist!</h3>
        <hr />
        <ul>
          <li>Create checklist and set status either Open/Closed</li>
          <li>Opened checklist listed in Home screen</li>
        </ul>
        <h3>Dark Mode!</h3>
        <hr />
        <ul>
          <li>
            Open Settings (‚öôÔ∏è) in the sidebar, then click the üåô button to
            toggle dark mode.
          </li>
          <li>Dark mode preference is saved.</li>
        </ul>
        <h3>Notification!</h3>
        <hr />
        <ul>
          <li>Notification will showed once page is active</li>
          <li>You will Turn Notification On/Off</li>
          <li>
            When app is active then only Notification showed,Background push
            Notification's are restricted
          </li>
          <li>You can customize notification as per your requirements</li>
        </ul>
        <h3>Offline Mode</h3>
        <hr />
        <ul>
          <li>
            Step: Download Source Code Zip File in your Device and Extract foder
            then Open index.html without internet in any broweser.
          </li>
          <li>Note: notifications are not supposed to working</li>
          <li> New features you may missed</li>
        </ul>
      </div>
      <div id="utilities" class="page hidden">
        <h2>üõ†Ô∏è Utilities</h2>
        <div class="add-area">
          <button
            id="monthlyCalendarToggle"
            class="add-btn"
            aria-expanded="false"
          >
            üìÖ MONTHLY CALENDAR <span class="arrow">‚ñº</span>
          </button>
          <div id="monthlyCalendarContainer" class="form" aria-hidden="true">
            <div
              id="calendarDisplay"
              style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
            >
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"
              >
                <button id="prevMonthBtn" class="secondary">‚óÄ</button>
                <h4 id="currentMonthYear"></h4>
                <button id="nextMonthBtn" class="secondary">‚ñ∂</button>
              </div>
              <div
                id="calendarGrid"
                style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 14px;"
              >
                <div>S</div>
                <div>M</div>
                <div>T</div>
                <div>W</div>
                <div>T</div>
                <div>F</div>
                <div>S</div>
              </div>
            </div>
            <!-- CURRENT TAMIL MONTH BOX -->
          <div id="currentTamilMonthBox"
               style="padding:10px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px;background:#f8f8f8;">
            <h3 style="text-align:center;margin:0 0 8px 0;">‡Æá‡Æ©‡Øç‡Æ±‡Øà‡ÆØ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡ÆÆ‡Ææ‡Æ§‡ÆÆ‡Øç</h3>
            <p id="currentTamilMonthText" style="font-weight:600;text-align:center;"></p>
          </div>
          </div>
        </div>
        <div class="add-area">
          <button id="calculatorToggle" class="add-btn" aria-expanded="false">
            üßÆ CALCULATOR <span class="arrow">‚ñº</span>
          </button>
          <div id="calculatorContainer" class="form" aria-hidden="true">
            <label>
              SELECT MODE:
              <select id="calculatorMode">
                <option value="normal">Normal Calculator</option>
                <option value="age">Age Calculator</option>
                <option value="date">Date Difference Calculator</option>
                <option value="bmi">BMI Calculator</option>
                <option value="eb">EB Calculator</option>
                <option value="scientific" disabled>
                  Scientific Calculator (WIP)
                </option>
              </select>
            </label>
            <div id="normalCalculator" class="calculator-mode">
              <input
                type="text"
                id="normalDisplay"
                value="0"
                readonly
                style="text-align: right; font-size: 20px; margin-bottom: 8px;"
              />
              <div
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;"
              >
                <button
                  class="secondary normal-btn"
                  data-value="clear"
                  style="grid-column: span 2;"
                >
                  C
                </button>
                <button class="secondary normal-btn" data-value="backspace">
                  ‚å´
                </button>
                <button class="secondary normal-btn" data-value="/">/</button>

                <button class="primary normal-btn" data-value="7">7</button>
                <button class="primary normal-btn" data-value="8">8</button>
                <button class="primary normal-btn" data-value="9">9</button>
                <button class="secondary normal-btn" data-value="*">*</button>

                <button class="primary normal-btn" data-value="4">4</button>
                <button class="primary normal-btn" data-value="5">5</button>
                <button class="primary normal-btn" data-value="6">6</button>
                <button class="secondary normal-btn" data-value="-">-</button>

                <button class="primary normal-btn" data-value="1">1</button>
                <button class="primary normal-btn" data-value="2">2</button>
                <button class="primary normal-btn" data-value="3">3</button>
                <button class="secondary normal-btn" data-value="+">+</button>

                <button
                  class="primary normal-btn"
                  data-value="."
                  style="font-weight: bold;"
                >
                  .
                </button>
                <button class="primary normal-btn" data-value="0">0</button>
                <button
                  class="primary normal-btn"
                  data-value="equals"
                  style="grid-column: span 2; background: var(--accent);"
                >
                  = Save & Calc
                </button>
              </div>
            </div>
            <div id="ageCalculator" class="calculator-mode hidden">
              <label>Date of Birth <input type="date" id="dobInput" /></label>
              <label>As of Date <input type="date" id="asOfDateInput" /></label>
              <div class="form-actions">
                <button id="calculateAgeBtn" class="primary">
                  Calculate Age
                </button>
              </div>
              <p id="ageResult" style="margin-top: 10px; font-weight: 600;"></p>
            </div>
            <div id="dateCalculator" class="calculator-mode hidden">
              <label>Start Date <input type="date" id="dateDiffStart" /></label>
              <label>End Date <input type="date" id="dateDiffEnd" /></label>
              <div class="form-actions">
                <button id="calculateDateDiffBtn" class="primary">
                  Calculate Difference
                </button>
              </div>
              <p
                id="dateDiffResult"
                style="margin-top: 10px; font-weight: 600;"
              ></p>
            </div>
            <!-- ---------- BMI Calculator ---------- -->
        <div class="calculator-mode hidden" id="bmiCalculator">
          <h3>üßÆ BMI Calculator</h3>
        
          <div class="bmi-input-group">
            <label>Age:</label>
            <input type="number" id="bmiAge" min="1" placeholder="Enter age" />
          </div>
        
          <div class="bmi-input-group">
            <label>Height (cm):</label>
            <input type="number" id="bmiHeight" min="50" placeholder="Enter height in cm" />
          </div>
        
          <div class="bmi-input-group">
            <label>Weight (kg):</label>
            <input type="number" id="bmiWeight" min="1" placeholder="Enter weight in kg" />
          </div>
        
          <button id="calcBMIButton">Calculate BMI</button>
          <p id="bmiResult" style="margin-top: 8px; font-weight: 600;"></p>
        </div>
        <div id="ebCalculator" class="calculator-mode hidden">
        <h3>‚ö° EB BILL CALCULATOR</h3>
      
        <label>
          CONSUMER NO / NAME
          <input type="text" id="ebConsumerName" placeholder="Optional">
        </label>
      
        <label>
          OLD EB READING
          <input type="number" id="ebOldReading" placeholder="e.g., 1000">
        </label>
      
        <label>
          NEW EB READING
          <input type="number" id="ebNewReading" placeholder="e.g., 1200">
        </label>
      
        <label>
          CONSUMED UNITS
          <input type="number" id="ebConsumedUnits"placeholder="auto return"; readonly style="background:#eee;">
        </label>
      
        <button id="calcEbBtn" class="primary">Calculate EB Bill</button>
      
        <h4>Editable Tariff Table</h4>
        <table id="ebTariffTable" style="width:100%;border-collapse:collapse;"></table>
      
        <button id="resetSlabs" class="secondary" style="margin-top:8px;">Reset Slabs to Default</button>
      
        <p id="ebResult" style="margin-top:12px;font-weight:700;"></p>
        </div>
        </div>
        <button id="moonPhaseToggle">üåô MOON PHASE<span class="arrow">‚ñº</span></button>
        <div id="moonPhaseContainer" class="hidden"></div>
        <button id="sunBtn">üåÖ SUNRISE & SUNSET<span class="arrow">‚ñº</span></button>
        <div id="sunBox" class="hidden">
          <label>Select Location</label>
          <select id="sunCity">
            <option value="kanyakumari">Kanyakumari</option>
            <option value="chennai">Chennai</option>
            <option value="madurai">Madurai</option>
            <option value="coimbatore">Coimbatore</option>
            <option value="trichy">Trichy</option>
            <option value="tirunelveli">Tirunelveli</option>
            <option value="pondicherry">Pondicherry</option>
            <option value="bengaluru">Bengaluru</option>
            <option value="mumbai">Mumbai</option>
            <option value="delhi">Delhi</option>
            <option value="custom">Custom (Lat/Lng)</option>
          </select>
          <div id="customInputs" style="display:none; margin-top:5px;">
            <input type="number" id="latInput" placeholder="Latitude (e.g. 8.0883)">
            <input type="number" id="lngInput" placeholder="Longitude (e.g. 77.5385)">
          </div>
          <div id="sunResult" style="margin-top:10px; font-weight:600;"></div>
        </div>
        </div>
        <!-- GOLD RATE (MINIMAL, API-ONLY, NO EXTRA OPTIONS) -->
        <div class="add-area">

        <button id="goldRateToggle" class="add-btn" aria-expanded="false">
          ü•á GOLD RATE TODAY <span class="arrow">‚ñº</span>
        </button>

        <div id="goldRateForm" class="form" aria-hidden="true">

          <label>SELECT PLACE</label>
          <select id="goldPlace1"></select>

          <label style="margin-top:12px;">SELECT PLACE</label>
          <select id="goldPlace2"></select>

          <div id="goldStatus" style="margin-top:10px;font-weight:600;"></div>

          <div id="goldTables" style="margin-top:12px;"></div>

          <button id="goldRefreshBtn" class="secondary" style="width:100%;margin-top:12px;">
            Check Again
          </button>
        </div>
        </div>
        <div class="add-area">
        <button id="weatherToggle" class="add-btn" aria-expanded="false">
        ‚òÅÔ∏è WEATHER FORECAST <span class="arrow">‚ñº</span>
      </button>
      
      <div id="weatherForm" class="form" aria-hidden="true">
        
        <label>SELECT PLACE</label>
        <select id="weatherCity"></select>
      
        <div id="weatherStatus" style="margin-top:10px;font-weight:600;"></div>
        <div id="weatherOutput" style="margin-top:12px;"></div>
      
        <button id="weatherRefreshBtn" class="secondary" style="width:100%;margin-top:12px;">Refresh</button>
      </div>
      </div>
        <div class="add-area">
          <button id="viewHistoryToggle" class="add-btn" aria-expanded="false">
            ‚è≥ VIEW HISTORY <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="calculationHistoryList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>
      <div id="trash" class="page hidden">
        <h2>üóëÔ∏è Trash Bin</h2>
        <p style="opacity:0.8;">DELETED ITEM'S ARE HERE.</p>
        <button id="emptyTrashBtn" class="icon-small" style="margin-bottom:10px;background:#d9534f;color:white;border:none;border-radius:6px;padding:9px 50px;cursor:pointer;">
          üßπ EMPTY TRASH
        </button>
        <ul id="trashList" class="list scrollable-list form"></ul>
      </div>
      <div id="other" class="page hidden">
        <h2>üé≤ More Apps</h2>
        <div
          style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px;"
        >
          <a
            href="https://you-tube-seven.vercel.app/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              YouTube Filter
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/QR-Generator/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">QR Generator</button>
          </a>
          <a
            href="https://spydernet3.github.io/multi_website_browser/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Multi Website Browser
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/Battery_Health_Monitor/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Battery Health Monitor
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/farewell/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Farewell Wishes
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/live-audio-transcrib/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Email Alert</button>
          </a>
          <a
            href="https://github.com/spydernet3/Text-messaging-alert"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">SmS Alert</button>
          </a>
          <a
            href="https://spydernet3.github.io/live-audio-transcrib/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Live Audio Transcrib
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/Notepad/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Notepad</button>
          </a>
          <a
            href="https://spydernet3.github.io/Meta-Card/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Meta Card</button>
          </a>
        </div>
      </div>
    </div>
    <script>
      // <!-- NOTIFICATION FIX 1: Cleaned up Service Worker Registration -->
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then((registration) => {
              console.log('SW registered successfully:', registration);
            })
            .catch((error) => {
              console.error('SW registration failed:', error);
            });
        });
      }
    let deferredPrompt;
    
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "block";
    });
    
    async function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById("installBtn").style.display = "none";
    }
    
      (function () {
        // ---------- Helpers ----------
        function byId(id){ return document.getElementById(id); }
        function rerenderFor(type){
        switch(type){
          case 'reminders':
            renderReminders(); renderHomeReminders(); break;
          case 'notes':
            renderNotes(); renderHomeNotes(); break;
          case 'budget':
            renderBudgets(); renderHomeBudgets(); break;
          case 'checklists':
            renderChecklists(); renderHomeCheck(); break;
          case 'calculationHistoryList':
          targetPageId = 'utilities';
          break;
              }
            }
        // ---------- NEW: Notification Settings Logic ----------
        function updateBrowserPermissionUI() {
            const status = Notification.permission;
            const textEl = byId('browserPermissionText');
            const boxEl = byId('globalNotifStatus');
            const btnEl = byId('requestPermissionBtn');

            if (!textEl || !boxEl || !btnEl) return; // Add guards for elements

            boxEl.classList.remove('denied');

            if (status === 'granted') {
                textEl.innerHTML = 'Status: <b style="color: var(--accent);">Granted (ON)</b>';
                btnEl.textContent = 'Permission Granted';
                btnEl.disabled = true;
            } else if (status === 'denied') {
                textEl.innerHTML = 'Status: <b style="color: #f44336;">Denied (OFF)</b>. Please change in browser settings.';
                btnEl.textContent = 'Permission Denied';
                btnEl.disabled = true;
                boxEl.classList.add('denied');
            } else { // 'default' or not supported
                textEl.innerHTML = 'Status: <b style="color: #ff9800;">Not Requested (OFF)</b>';
                btnEl.textContent = 'Request Permission';
                btnEl.disabled = false;
            }
        }

        function requestNotificationPermission() {
          if (!("Notification" in window)) {
              console.error("This browser does not support desktop notification");
              return;
          }
          if (Notification.permission === 'granted' || Notification.permission === 'denied') {
             updateBrowserPermissionUI();
             return;
          }

          Notification.requestPermission().then(function(permission) {
              updateBrowserPermissionUI();
          });
        }

        function renderNotificationPage() {
            if (!("Notification" in window)) {
                const statusBox = byId('globalNotifStatus');
                if (statusBox) statusBox.innerHTML = '<h3>Browser Permission</h3><p style="color: #f44336;">Notifications are not supported by your browser.</p>';
                return;
            }

            updateBrowserPermissionUI();

            // Setup custom category toggles based on appData
            if(byId('toggleReminders')) byId('toggleReminders').checked = appData.notifReminders;
            if(byId('toggleNotes')) byId('toggleNotes').checked = appData.notifNotes;
            if(byId('toggleChecklist')) byId('toggleChecklist').checked = appData.notifChecklist;
            if(byId('toggleBudget')) byId('toggleBudget').checked = appData.notifBudget;
            if(byId('toggleMoonPhase')) byId('toggleMoonPhase').checked = appData.notifMoonPhase;
        }

        // Function to handle custom toggle changes
        function handleCustomNotifToggle(category, event) {
            appData[category] = event.target.checked;
            saveAll();
            // Re-check notifications immediately if a new category is toggled on
            if (event.target.checked) checkNotifications();
        }
        byId('toggleMoonPhase')?.addEventListener('change', (e) =>
         handleCustomNotifToggle('notifMoonPhase', e)
        );

        // ---------- Storage ----------

        // Enhanced storage with quota handling
        const STORAGE_KEY = 'smart_reminder_app_v1';

        const defaultData = {
          reminders: [],
          notes: [],
          profileName: '',
          profilePhoto: '',
          darkMode: '0',
          budget: [],
          checklists: [],
          // NEW: Notification preferences
          notifReminders: true,
          notifNotes: true,
          notifChecklist: true,
          notifBudget: true,
          notifMoonPhase: true,
          // NEW: Calculation History
          calculationHistory: [],
          trash: [],
        };

        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;
        // Merge with defaults to ensure new notif keys are present on load
        appData = { ...defaultData, ...appData };
        // Ensure new property is initialized if old data exists
        if (!appData.calculationHistory) appData.calculationHistory = [];

        let editingIndex = null;
        let editingBudgetIndex = null;
        let editingCheckIndex = null;
        let editingNoteIndex = null;
        let editingHistoryIndex = null; // NEW: for history editing
        let currentMonth = new Date().getMonth(); // NEW: Calendar state
        let currentYear = new Date().getFullYear(); // NEW: Calendar state

        // <!-- NOTIFICATION FIX 3: Modified saveAll to be async and call checkNotifications -->
        // Modified save function to use localStorage only
        async function saveAll() {
          try {
            const dataStr = JSON.stringify(appData);
            localStorage.setItem(STORAGE_KEY, dataStr);
            console.log("Data saved successfully to localStorage.");
            if (typeof updateStorageUsage === "function") updateStorageUsage();
            // Re-render the notification page whenever data changes (if the page is active)
            if (byId('notifications') && !byId('notifications').classList.contains('hidden')) {
               renderNotificationPage();
            }
            // NOTIFICATION CHANGE: Trigger notification check on every data save.
            await checkNotifications(); // Correctly awaiting the async function
            } catch (err) {
              console.error("Save failed:", err);
              if (err.name === 'QuotaExceededError') {
                console.error("Storage is full. Please delete some data to make space.");
              }
            }
          }

        function daysLeft(endDateStr){
          if(!endDateStr) return null;
          const [y,m,d] = endDateStr.split('-').map(Number);
          const end = new Date(y,m-1,d);
          const now = new Date();
          const diffTime = end.setHours(0,0,0,0) - now.setHours(0,0,0,0);
          return Math.floor(diffTime / (1000*60*60*24));
        }

        function formatDMY(dateStr){
          if(!dateStr) return '';
          const [y,m,d] = dateStr.split('-');
          return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;
        }

        // Format date as DD-MMM-YYYY with IST time (12-hour format)
        function formatDateDMYWithTime(date) {
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                         'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = date.getDate().toString().padStart(2, '0');
          const month = months[date.getMonth()];
          const year = date.getFullYear();

          // Get IST time (UTC+5:30)
          const istHours = date.getHours();
          const istMinutes = date.getMinutes().toString().padStart(2, '0');
          const ampm = istHours >= 12 ? 'PM' : 'AM';
          const displayHours = istHours % 12 || 12;

          return `${day}-${month}-${year} ${displayHours}:${istMinutes} ${ampm}`;
        }

        // Calculate days between two dates
        function daysBetween(startDateStr, endDateStr) {
          if (!startDateStr || !endDateStr) return 0;
          const [startY, startM, startD] = startDateStr.split('-').map(Number);
          const [endY, endM, endD] = endDateStr.split('-').map(Number);
          const start = new Date(startY, startM-1, startD);
          const end = new Date(endY, endM-1, endD);
          const diffTime = end.setHours(0,0,0,0) - start.setHours(0,0,0,0);
          return Math.floor(diffTime / (1000*60*60*24)) + 1; // +1 to include both start and end dates
        }

        // Calculate cost per day
        function calculateCostPerDay(amount, startDate, endDate) {
          const days = daysBetween(startDate, endDate);
          if (days <= 0 || amount <= 0) return 0;
          return (amount / days).toFixed(2);
        }

        function renderReminders(){
          const list = byId('reminderList'); list.innerHTML = '';
            if(appData.reminders.length === 0){
            const li = document.createElement('li'); li.textContent='No reminders yet.'; li.style.opacity='0.7'; list.appendChild(li);
            renderHomeReminders(); renderHomeNotes(); renderHomeCheck();renderHomeOverview(); return;
          }
          const frag = document.createDocumentFragment();
          appData.reminders.forEach((r,i)=>{
            const li=document.createElement('li');
            const left=document.createElement('div'); left.className='item-left';
            const title=document.createElement('div'); title.textContent=r.title; title.style.fontWeight='600';
            const dates=document.createElement('div'); dates.style.fontSize='13px'; dates.style.opacity='0.85'; dates.textContent=`Start: ${formatDMY(r.startDate)} | End: ${formatDMY(r.endDate)}`;
            left.appendChild(title); left.appendChild(dates);

            const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
            const badge=document.createElement('div'); badge.className='badge';
            const diff = daysLeft(r.endDate);
            if(diff === null){ badge.textContent='No date'; }
            else if(diff < 0){ badge.textContent='Expired'; }
            else if(diff === 0){ badge.textContent='Today'; }
            else{ badge.textContent=`${diff} days left`; }

            const editBtn=document.createElement('button'); editBtn.className='icon-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit'; editBtn.addEventListener('click',()=>editReminder(i));
            const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>deleteReminder(i));

            right.appendChild(badge);
            right.appendChild(editBtn);
            right.appendChild(delBtn);
            li.appendChild(left); li.appendChild(right); frag.appendChild(li);
          });
          list.appendChild(frag);
          renderHomeReminders(); renderHomeNotes(); renderHomeCheck();renderHomeOverview();
        }

        function renderHomeReminders(){
          const container = byId('homeRemindersContainer');
          container.innerHTML='';
          // Filter reminders to show only today and 1 day left
          const filteredReminders = appData.reminders.filter(r => {
            const diff = daysLeft(r.endDate);
            return diff === 0 || diff === 1 || diff < 0;

          });

          if(filteredReminders.length === 0){
            const li=document.createElement('li');
            li.textContent='No reminders for today or tomorrow.';
            li.style.opacity='0.7';
            container.appendChild(li);
            return;
          }

          const frag=document.createDocumentFragment();
          filteredReminders.forEach(r=>{
            const li=document.createElement('li');
            const diff = daysLeft(r.endDate);
            let badgeText='';
            if(diff === null){ badgeText='No date'; }
            else if(diff < 0){ badgeText='Expired'; }
            else if(diff === 0){ badgeText='Today'; }
            else{ badgeText=`${diff} days left`; }
            li.textContent = `\"${r.title}\" || ${badgeText}`;
            frag.appendChild(li);
          });
          container.appendChild(frag);
        }

        // Update renderHomeNotes function to handle table formatting
        function renderHomeNotes(){
          const container = byId('homeNotesContainer');
          container.innerHTML = '';

          if(appData.notes.length === 0){
            const li = document.createElement('li');
            li.textContent = 'No notes available.';
            li.style.opacity = '0.7';
            container.appendChild(li);
            return;
          }

          const frag = document.createDocumentFragment();

          appData.notes.forEach(n => {
            const li = document.createElement('li');
            li.className = 'list-item';

            const left = document.createElement('div');
            left.className = 'item-left';

            // Main Text/Table Content
            const text = document.createElement('div');
            if(n.isTable && n.text) {
              // Show first few rows of table in home view
              const lines = n.text.split('\n');
              let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse;text-align:center; width: 100%;\">';

              lines.forEach((line, index) => {
                if(line.includes('---')) {
                  if(index > 0) tableHTML += '</tr>';
                  tableHTML += '<tr>';
                } else if(line.includes('|')) {
                  const cells = line.split('|').filter(cell => cell.trim() !== '');
                  cells.forEach(cell => {
                    const cellContent = cell.trim();
                    if(index === 0) {
                      tableHTML += `<th style=\"border: 1px solid #ddd;text-align:center; padding: 4px;\">${cellContent}</th>`;
                    } else {
                      tableHTML += `<td style=\"border: 1px solid #ddd;text-align:center; padding: 4px;\">${cellContent}</td>`;
                    }
                  });
                }
              });

              tableHTML += '</tr></table>';
              text.innerHTML = tableHTML;
            } else {
              text.innerHTML = `<b>${(n.text || '').substring(0, 50)}...</b><br><small style=\"opacity:0.7\">${n.createdAt || ''}</small>`;
            }
            left.appendChild(text);

            // File Thumbnail Display - EXISTING, KEPT
            if (n.file && n.file.type && n.file.type.includes('image')) {
              const thumb = document.createElement('img');
              thumb.src = n.file.data;
              thumb.style.maxWidth = '40px';
              thumb.style.marginLeft = '5px';
              thumb.style.borderRadius = '4px';
              thumb.style.verticalAlign = 'middle';
              thumb.alt = n.file.name || 'image';
              left.appendChild(thumb);
            }

            li.appendChild(left);
            frag.appendChild(li);
          });

          container.appendChild(frag);
        }

        // Update renderNotes function to handle table formatting
        function renderNotes(){
          const list = byId('noteList'); list.innerHTML='';
          if(appData.notes.length===0){
            const li=document.createElement('li');
            li.textContent='No notes yet.'; li.style.opacity='0.7';
            list.appendChild(li);
            return;
          }
          const frag=document.createDocumentFragment();
          appData.notes.forEach((note,i)=>{
            const li=document.createElement('li');
            const left=document.createElement('div'); left.className='item-left';

            const text=document.createElement('div');
            if(note.isTable && note.text) {
              // Convert table format to HTML table
              const lines = note.text.split('\n');
              let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';

              lines.forEach((line, index) => {
                if(line.includes('---')) {
                  // Row separator - add closing tags for previous row
                  if(index > 0) tableHTML += '</tr>';
                  tableHTML += '<tr>';
                } else if(line.includes('|')) {
                  // Table row
                  const cells = line.split('|').filter(cell => cell.trim() !== '');
                  cells.forEach(cell => {
                    const cellContent = cell.trim();
                    if(index === 0) {
                      tableHTML += `<th style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</th>`;
                    } else {
                      tableHTML += `<td style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</td>`;
                    }
                  });
                }
              });

              tableHTML += '</tr></table>';
              text.innerHTML = tableHTML;
            } else {
              text.innerHTML=`<b>${note.text||''}</b><br>
                <small style=\"opacity:0.7\">${note.createdAt||''}</small>`;
            }
            left.appendChild(text);

            // --- file rendering - EXISTING, KEPT ---
            if(note.file){
              let fileEl;

              // üì∑ --- Image Support ---
              if(note.file.type.includes('image')){
                fileEl=document.createElement('img');
                fileEl.src=note.file.data;
                fileEl.style.maxWidth='200px';
                fileEl.style.display='block';
                fileEl.style.marginTop='5px';
              }
              // üéµ --- Audio Support ---
              else if(note.file.type.includes('audio')){
                fileEl=document.createElement('audio');
                fileEl.controls=true;
                fileEl.src=note.file.data;
              }
              // üé¨ --- Video Support ---
              else if(note.file.type.includes('video')){
                fileEl=document.createElement('video');
                fileEl.controls=true;
                fileEl.width=200;
                fileEl.src=note.file.data;
              }
              // üìÑ --- Docs (PDF/DOC) ---
              else {
                fileEl=document.createElement('a');
                fileEl.href=note.file.data;
                fileEl.download=note.file.name;
                fileEl.textContent='üìé '+note.file.name;
              }

              left.appendChild(fileEl);
            }

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.alignItems = 'center';

            const editBtn = document.createElement('button');
            editBtn.className = 'icon-small';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.title = 'Edit';
            editBtn.addEventListener('click', () => editNote(i));

            const delBtn=document.createElement('button');
            delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è';
            delBtn.title='Delete';
            delBtn.addEventListener('click',()=>{ deleteNote(i); });

            right.appendChild(editBtn);
            right.appendChild(delBtn);
            li.appendChild(left); li.appendChild(right); frag.appendChild(li);
          });
          list.appendChild(frag);
        }

        // ---------- Budget Functions ----------
        function renderBudgets() {
        const list = byId('budgetList');
        list.innerHTML = '';
        if (!appData.budget || !Array.isArray(appData.budget)) appData.budget = [];

        if (appData.budget.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No budgets yet.';
          li.style.opacity = '0.7';
          list.appendChild(li);
          renderHomeBudgets();
          return;
        }

        const frag = document.createDocumentFragment();

        appData.budget.forEach((b, i) => {
        const li = document.createElement('li');
        const left = document.createElement('div');
         left.className = 'item-left';

          const used = b.expenses ? b.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
          const remaining = b.amount - used;
          
          const start = b.startDate ? new Date(b.startDate) : null;
          const end = b.endDate ? new Date(b.endDate) : null;
          const days = daysLeft(b.endDate);
          const remainingPerDay = days > 0 ? (remaining / days).toFixed(2) : remaining;
          const title = document.createElement('div');
          title.textContent = `Title: ${b.title}`;
          title.style.fontWeight = '600';
          title.style.fontSize = '15px';

          const amounts = document.createElement('div');
          amounts.style.fontSize = '13px';
          amounts.style.opacity = '0.9';
          amounts.textContent = `üí∞ Total: ‚Çπ${b.amount} | Used: ‚Çπ${used} | Remaining: ‚Çπ${remaining}`;

          const expList = document.createElement('div');
          expList.style.marginTop = '6px';
          expList.style.fontSize = '13px';
          
         expList.innerHTML = (b.expenses && b.expenses.length)
          ? b.expenses
              .map(
                (e, idx) => `
              <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #333;padding:6px 0;">
        
                <!-- LEFT SIDE: DATE | TITLE | AMOUNT -->
                <div style="display:flex;gap:18px;align-items:center;font-size:14px;">
                  <span>üìÖ ${e.date}</span>
                  <span>üí∏ ${e.title}</span>
                  <span>‚Çπ${e.amount}</span>
                </div>
        
                <!-- RIGHT SIDE: EDIT + DELETE -->
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <button class="icon-small" onclick="editExpense(${i},${idx})">‚úèÔ∏è</button>
                  <button class="icon-small" onclick="deleteExpense(${i},${idx})">üóëÔ∏è</button>
                </div>
        
              </div>
              `
              )
              .join('')
          : `<p style="opacity:0.6;">No expenses yet</p>`;

            // --- EXPANDABLE FORM for adding expenses ---
            const expForm = document.createElement('div');
            expForm.className = 'expense-form';
            expForm.style.display = 'none';
            expForm.style.marginTop = '8px';
            expForm.innerHTML = `
              <input type="text" placeholder="Expense title" class="exp-title" 
                style="background:#ddd;color:#black;border:1px solid #444;border-radius:6px;padding:4px 6px;width:100%;margin-bottom:4px;">
              <input type="number" placeholder="Amount (‚Çπ)" class="exp-amount" 
                style="background:#ddd;color:#black;border:1px solid #444;border-radius:6px;padding:4px 6px;width:100%;margin-bottom:4px;">
              <button class="add-exp-confirm" style="background:#4caf50;color:#fff;border:none;border-radius:6px;padding:4px 8px;width:100%;">Add Expense</button>
            `;

            // --- Buttons section ---
            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.flexDirection = 'column';
            right.style.justifyContent = 'center';
            right.style.alignItems = 'center';
            right.style.gap = '10px';
            right.style.paddingTop = '6px';
            const addBtn = document.createElement('button');
            addBtn.textContent = '‚ûï';
            addBtn.className = 'icon-small';
            addBtn.title = 'Add Expense';
            addBtn.addEventListener('click', () => {
              expForm.style.display = expForm.style.display === 'none' ? 'block' : 'none';
            });

            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.className = 'icon-small';
            editBtn.title = 'Edit';
            editBtn.addEventListener('click', () => editBudget(i));

            const delBtn = document.createElement('button');
            delBtn.textContent = 'üóëÔ∏è';
            delBtn.className = 'icon-small';
            delBtn.title = 'Delete';
            delBtn.addEventListener('click', () => deleteBudget(i));

            right.append(addBtn, editBtn, delBtn);

            // --- Expense add button logic ---
            expForm.querySelector('.add-exp-confirm').addEventListener('click', () => {
              const expTitle = expForm.querySelector('.exp-title').value.trim();
              const expAmt = parseFloat(expForm.querySelector('.exp-amount').value.trim());
              if (!expTitle || isNaN(expAmt) || expAmt <= 0) return alert('Enter valid details');
              const expDate = new Date().toLocaleDateString('en-IN');

              if (!b.expenses) b.expenses = [];
              b.expenses.push({ title: expTitle, amount: expAmt, date: expDate });
              saveAll();
              renderBudgets();
            });

            left.append(title, amounts, expList, expForm);
            li.append(left, right);
            frag.appendChild(li);
          });

          list.appendChild(frag);
          renderHomeBudgets();
        }

        function renderHomeBudgets() {
          const container = byId('homeBudgetsContainer');
          container.innerHTML = '';

          // Ensure appData.budget exists and is an array
          if (!appData.budget || !Array.isArray(appData.budget)) {
            appData.budget = [];
          }

          if (appData.budget.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No budgets yet.';
            li.style.opacity = '0.7';
            container.appendChild(li);
            return;
          }

          const frag = document.createDocumentFragment();

          appData.budget.forEach(b => {
            if (!b.expenses) b.expenses = [];

             // Calculate total expenses and remaining
            const used = b.expenses.reduce((sum, e) => sum + Number(e.amount), 0);
            const remaining = b.amount - used;
            
            // Correct dynamic remaining days
            const days = daysLeft(b.endDate);  
            
            // Recalculate cost per day
            const costPerDay = days > 0 ? (remaining / days).toFixed(2) : 0;
            const li = document.createElement('li');
            li.style.fontSize = '14px';
            li.style.marginBottom = '5px';
            li.innerHTML = `
              <strong>"${b.title}"</strong><br>
              üí∞ Total: ‚Çπ${b.amount} &nbsp; | &nbsp; üí∏ Used: ‚Çπ${used} &nbsp; | &nbsp; üè¶ Remaining: ‚Çπ${remaining}<br>
              üïí ${days} days remaining &nbsp; | &nbsp; Cost: ‚Çπ${costPerDay}/day
            `;
            frag.appendChild(li);
          });

          container.appendChild(frag);
        }

        function editBudget(i){
          const b=appData.budget[i];
          editingBudgetIndex=i;
          byId('budgetTitle').value=b.title;
          byId('budgetAmount').value=b.amount;
          byId('budgetStartDate').value=b.startDate||'';
          byId('budgetEndDate').value=b.endDate||'';
          showForm(byId('budgetFormContainer'));
        }

        function saveBudget() {
        const title = byId('budgetTitle').value.trim();
        const amount = Number(byId('budgetAmount').value);
        const start = byId('budgetStartDate').value;
        const end = byId('budgetEndDate').value;
      
        if (!title || !amount) {
          alert("Title and amount are required.");
          return;
        }
      
        // New budget object (base data)
        const updatedObj = {
          title,
          amount,
          startDate: start,
          endDate: end,
        };
      
        // --------------- FIX 1: KEEP OLD EXPENSES ----------------
        if (editingBudgetIndex !== null) {
          const old = appData.budget[editingBudgetIndex];
          updatedObj.expenses = old.expenses ? [...old.expenses] : [];
          appData.budget[editingBudgetIndex] = updatedObj;
          editingBudgetIndex = null;
        } else {
          updatedObj.expenses = []; // new budget starts empty
          appData.budget.push(updatedObj);
        }
      
        saveAll();
        renderBudgets();
        renderHomeBudgets();
        hideForm(byId("budgetFormContainer"));
        clearBudgetForm();
      }
        function clearBudgetForm(){
          byId('budgetTitle').value='';
          byId('budgetAmount').value='';
          byId('budgetStartDate').value='';
          byId('budgetEndDate').value='';
        }

        function editReminder(i){
          const r=appData.reminders[i];
          editingIndex=i;
          byId('reminderTitle').value=r.title;
          byId('startDate').value=r.startDate||'';
          byId('endDate').value=r.endDate||'';
          showForm(byId('reminderFormContainer'));
        }

        function saveReminder(){
          const title=byId('reminderTitle').value.trim();
          const start=byId('startDate').value;
          const end=byId('endDate').value;
          if(!title){ alert('Title is required for the reminder.'); return; }
          const reminderObj={ title, startDate:start, endDate:end };
          if(editingIndex!==null){ appData.reminders[editingIndex]=reminderObj; editingIndex=null; }
          else{ appData.reminders.push(reminderObj); }
          saveAll(); renderReminders();renderHomeOverview(); hideForm(byId('reminderFormContainer')); clearReminderForm();
        }

        function clearReminderForm(){
          byId('reminderTitle').value='';
          byId('startDate').value='';
          byId('endDate').value='';
        }


        // Updated editNote
        function editNote(index){
          const note = appData.notes[index];
          editingNoteIndex = index;

          byId('noteText').value = note.text || '';
          byId('tableFormatCheckbox').checked = note.isTable || false;

          // Show the form
          showForm(byId('noteFormContainer'));

          // Set the save button to update instead of create
          byId('saveNoteBtn').textContent = 'Update';
        }

        // Updated saveNote (removed AI-related code)
        function saveNote(){
          const text = byId('noteText').value.trim();
          const fileInput = byId('noteFile');
          const file = fileInput.files[0];
          const isTableFormat = byId('tableFormatCheckbox').checked;

          if(!text && !file){
            alert('Note cannot be empty. Please add text or a file.');
            return;
          }

          // Format date for all notes
          const noteDate = formatDateDMYWithTime(new Date());

          let noteText = text;
          if (isTableFormat && text) {
            // Add date/time to the beginning of the table
            noteText = `Created: ${noteDate}\n\n${text}`;
          }

          const noteObj = {
            text: noteText,
            createdAt: noteDate,
            file: null,
            isTable: isTableFormat,
          };

          const finalizeSave = (noteObj) => {
              if(editingNoteIndex !== null){
                  appData.notes[editingNoteIndex] = noteObj;
                  editingNoteIndex = null;
              } else {
                  appData.notes.push(noteObj);
              }
              saveAll(); renderNotes(); renderHomeNotes();
              hideForm(byId('noteFormContainer'));
              byId('noteText').value='';
              fileInput.value='';
              byId('tableFormatCheckbox').checked = false;
              byId('saveNoteBtn').textContent = 'Save';
          }

          if(file){
            const reader = new FileReader();
            reader.onload = function(e){
              noteObj.file = {
                name: file.name,
                type: file.type,
                data: e.target.result
              };
              finalizeSave(noteObj);
            };
            reader.onerror = function() {
              console.error('Error reading file. Please try again.');
              fileInput.value = '';
            };
            reader.readAsDataURL(file);
          } else {
            finalizeSave(noteObj);
          }
        }


        function editCheck(index){
          const check = appData.checklists[index];
          editingCheckIndex = index;

          byId('checkTitle').value = check.title || '';
          byId('checkStatus').value = check.status || 'open';
          byId('checkItems').value = check.items ? check.items.join('\n') : '';

          // Show the form
          showForm(byId('checkFormContainer'));

          // Set the save button to update instead of create
          byId('saveCheckBtn').textContent = 'Update';
        }

        function toggleCheckStatus(index) {
          const check = appData.checklists[index];
          check.status = check.status === 'open' ? 'closed' : 'open';
          saveAll();
          renderChecklists();
          renderHomeCheck();
        }

        function saveCheck(){
          const title = byId('checkTitle').value.trim();
          const status = byId('checkStatus').value;
          const itemsText = byId('checkItems').value.trim();
          const items = itemsText ? itemsText.split('\n').filter(item => item.trim() !== '') : [];

          if(!title){
            alert('Title is required for the checklist.');
            return;
          }

          const checkObj = {
            title,
            items,
            status: status,
            createdAt: formatDateDMYWithTime(new Date()) // Use DD-MMM-YYYY with IST time format
          };

          if(editingCheckIndex !== null){
            appData.checklists[editingCheckIndex] = checkObj;
            editingCheckIndex = null;
          } else {
            appData.checklists.push(checkObj);
          }

          saveAll();
          renderChecklists();
          renderHomeCheck();

          hideForm(byId('checkFormContainer'));
          byId('checkTitle').value = '';
          byId('checkStatus').value = 'open';
          byId('checkItems').value = '';
          byId('saveCheckBtn').textContent = 'Save';
        }


        function renderHomeCheck(){
          const container = byId('homeCheckContainer');
          container.innerHTML = '';

          // Ensure appData.checklists exists and is an array
          if (!appData.checklists || !Array.isArray(appData.checklists)) {
            appData.checklists = [];
          }

          if(appData.checklists.length === 0){
            const li = document.createElement('li');
            li.textContent = 'No checklists yet.';
            li.style.opacity = '0.7';
            container.appendChild(li);
            return;
          }

          const frag = document.createDocumentFragment();

          appData.checklists.forEach(check => {
            if(check.status === 'open') {
              const li = document.createElement('li');
              li.textContent = `\"${check.title}\" - ${check.items.length} items`; // Use items.length
              frag.appendChild(li);
            }
          });

          if (frag.children.length === 0) { // Check if any open checklists were found
              const li = document.createElement('li');
              li.textContent = 'No open checklists.';
              li.style.opacity = '0.7';
              container.appendChild(li);
          } else {
              container.appendChild(frag);
          }
        }

        function renderChecklists(){
          const list = byId('checkList'); list.innerHTML = '';
          // Ensure appData.checklists exists and is an array
          if (!appData.checklists || !Array.isArray(appData.checklists)) {
            appData.checklists = [];
          }
          if(appData.checklists.length === 0){
            const li = document.createElement('li'); li.textContent='No checklists yet.'; li.style.opacity='0.7'; list.appendChild(li);
            renderHomeCheck();return;
          }
          const frag = document.createDocumentFragment();
          appData.checklists.forEach((check,i)=>{
            const li=document.createElement('li');
            const left=document.createElement('div'); left.className='item-left';

            const title=document.createElement('div');
            title.textContent=`${check.title}`;
            title.style.fontWeight='600';

            // START OF MODIFICATION: Display checklist items
            const itemsPreview=document.createElement('div');
            itemsPreview.style.fontSize='13px';
            itemsPreview.style.opacity='0.9';

            // Get the first 3 items or all items if less than 3
            const previewItems = check.items.slice(0, 3);
            let itemsText = previewItems.map(item => `\u2022 ${item}`).join('<br>'); // \u2022 is a bullet point

            // Add an ellipsis if there are more than 3 items
            if(check.items.length > 3) {
                itemsText += '<br>... and ' + (check.items.length - 3) + ' more items';
            } else if (check.items.length === 0) {
                itemsText = 'No items in list.';
            }

            itemsPreview.innerHTML = itemsText;
            // END OF MODIFICATION

            const statusInfo=document.createElement('div');
            statusInfo.style.fontSize='13px';
            statusInfo.style.opacity='0.85';
            statusInfo.textContent=`Status: ${check.status} | Total Items: ${check.items.length}`;

            const time=document.createElement('div');
            time.style.fontSize='12px';
            time.style.opacity='0.7';
            time.textContent=check.createdAt || '';

            left.appendChild(title);
            left.appendChild(itemsPreview); // Added the item preview
            left.appendChild(statusInfo);
            left.appendChild(time);

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.alignItems = 'center';

            // Add status button
            const statusBtn = document.createElement('button');
            statusBtn.className = 'status-btn';
            statusBtn.textContent = check.status === 'open' ? 'Open' : 'Closed';
            statusBtn.title = 'Change Status';
            statusBtn.addEventListener('click', () => toggleCheckStatus(i));

            const editBtn = document.createElement('button');
            editBtn.className = 'icon-small';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.title = 'Edit';
            editBtn.addEventListener('click', () => editCheck(i));

            const delBtn=document.createElement('button');
            delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è';
            delBtn.title='Delete';
            delBtn.addEventListener('click',()=>{ deleteCheck(i); });

            right.appendChild(statusBtn);
            right.appendChild(editBtn);
            right.appendChild(delBtn);
            li.appendChild(left); li.appendChild(right); frag.appendChild(li);
          });
          list.appendChild(frag);
          renderHomeCheck();renderHomeOverview();
          }
          // ---------- Trash Bin ----------
          function renderTrash(){
            const list = byId('trashList');
            if(!list) return;
            list.innerHTML = '';
            if(!appData.trash.length){
              const li = document.createElement('li');
              li.textContent = 'Trash is empty.';
              li.style.opacity = '0.7';
              list.appendChild(li);
              return;
            }
            const frag = document.createDocumentFragment();
            appData.trash.forEach((t,i)=>{
              const li = document.createElement('li');
              const left = document.createElement('div');
              left.className = 'item-left';
              left.innerHTML = `<b>${t.type.toUpperCase()}</b><br>${(t.item.title||t.item.text||'Untitled')}<br><small>Deleted: ${new Date(t.deletedAt).toLocaleString()}</small>`;
              const right = document.createElement('div');
              right.style.display = 'flex';
              const restoreBtn = document.createElement('button');
              restoreBtn.className = 'icon-small';
              restoreBtn.textContent = '‚ôªÔ∏è';
              restoreBtn.title = 'Restore';
              restoreBtn.onclick = ()=>restoreFromTrash(i);
              const delBtn = document.createElement('button');
              delBtn.className = 'icon-small';
              delBtn.textContent = '‚ùå';
              delBtn.title = 'Delete Forever';
              delBtn.onclick = ()=>deleteForever(i);
              right.appendChild(restoreBtn);
              right.appendChild(delBtn);
              li.appendChild(left);
              li.appendChild(right);
              frag.appendChild(li);
            });
            list.appendChild(frag);
          }
          
          function restoreFromTrash(i){
            const t = appData.trash[i];
            if(!t) return;
            if(Array.isArray(appData[t.type])) appData[t.type].push(t.item);
            appData.trash.splice(i,1);
            saveAll();
            renderTrash();
            alert(`${t.type} item restored.`);
          }
          
          function deleteForever(i){
            if(confirm('Delete permanently?')){
              appData.trash.splice(i,1);
              saveAll();
              renderTrash();
            }
          }
          function emptyTrashAll() {
          if (!appData.trash || appData.trash.length === 0) {
            alert("Trash already empty.");
            return;
          }

          if (!confirm("Clear all items from Trash?")) return;

          appData.trash = [];
          saveAll();
          renderTrash();
          alert("Trash cleared successfully.");
        }
        // ---------- Form Show/Hide ----------
        function showForm(el){ el.classList.add('visible'); }
        function hideForm(el){ el.classList.remove('visible'); }

        // ---------- Page Navigation ----------
        const sidebar = byId('sidebar');
        const main = byId('main');
        const toggleBtn = byId('toggleBtn');

        function showPage(pageId){
          document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
          const targetPage = byId(pageId);
          targetPage.classList.remove('hidden');

          // Special handling for the notifications page
          if (pageId === 'notifications') {
            renderNotificationPage();
          }

          // Auto-hide sidebar instantly when an option is chosen
          sidebar.style.left = '-220px';
          main.style.marginLeft = '0';
          toggleBtn.textContent = 'üêµ';
          sidebar.style.transition = 'left 0s';   // instant hide
          main.style.transition = 'margin-left 0s'; // instant hide
        }

        // ---------- Sidebar Toggle ----------
        toggleBtn.addEventListener('click', function() {
          if (sidebar.style.left === '-220px' || sidebar.style.left === '') {
            sidebar.style.left = '0px';
            main.style.marginLeft = '220px';
            toggleBtn.textContent = 'üêí';
          } else {
            sidebar.style.left = '-220px';
            main.style.marginLeft = '0';
            toggleBtn.textContent = 'üêµ';
          }
        });

        // ---------- Settings Panel (new) ----------
        const settingsBtn = byId('settingsBtn');
        const settingsPanel = byId('settingsPanel');
        if(settingsBtn && settingsPanel){
          settingsBtn.addEventListener('click', ()=>{
            const opened = settingsPanel.classList.toggle('visible');
            settingsBtn.setAttribute('aria-expanded', opened);
            settingsPanel.setAttribute('aria-hidden', !opened);
          });
        }

        // ---------- Dark Mode ----------
        const darkBtn=byId('darkModeBtn');
        darkBtn.addEventListener('click',()=>{
          document.body.classList.toggle('dark');
          appData.darkMode=document.body.classList.contains('dark')?'1':'0';
          saveAll();
        });

        // ---------- Profile ----------
        const profileNameEl=byId('profileName');
        byId('editNameBtn').addEventListener('click',()=>{
          const n=prompt('Enter new name:',appData.profileName||'');
          if(n){
            appData.profileName=n;
            profileNameEl.textContent=n;
            saveAll();
          }
        });

        const profilePhotoInput=byId('photoUpload');
        profilePhotoInput.addEventListener('change',(e)=>{
          const file=e.target.files[0];
          if(file){
            const reader=new FileReader();
            reader.onload=function(ev){
              appData.profilePhoto=ev.target.result;
              byId('profilePhoto').src=ev.target.result;
              saveAll();
            };
            reader.readAsDataURL(file);
          }
        });

        // Helper 4: Notes (Summary of recent notes)
        function buildNotesSummary() {
            let summary = [];
            if (appData.notes.length === 0) return "No notes added yet.";
            const recentNotes = appData.notes.slice(-3).reverse();
            recentNotes.forEach(n => {
                let notePreview = n.text;
                if (n.isTable) notePreview = "[Table Note]";
                else if (notePreview && notePreview.length > 30) notePreview = notePreview.substring(0, 30) + "...";
                else if (!notePreview && n.file) notePreview = `[File: ${n.file.name}]`;
                else if (!notePreview) notePreview = "[Empty Note]";
                const datePart = n.createdAt ? n.createdAt.split(' ')[0] : '';
                summary.push(`- ${notePreview} (${datePart})`);
            });
            if (appData.notes.length > 3) summary.push(`... and ${appData.notes.length - 3} older notes.`);
            return summary.join('\n');
        }

        // Helper 1: Reminders (Today or Tomorrow)
        function buildReminderSummary() {
            let summary = [];
            appData.reminders.forEach(r => {
                const diff = daysLeft(r.endDate);
                if (diff < 0) {
              summary.push(`${r.title} ‚Äî ‚ùóExpired (${formatDMY(r.endDate)})`);
              }
              else if (diff === 0) {
                  summary.push(`${r.title} ‚Äî Today`);
              }
              else if (diff === 1) {
                  summary.push(`${r.title} ‚Äî Tomorrow`);
              }
      
                  });
                  return summary.length > 0 ? summary.join('\n') : "No reminders due today/tomorrow.";
              }

        // Helper 2: Checklist (Open status)
        function buildChecklistSummary() {
            let summary = [];
            const openChecks = appData.checklists.filter(c => c.status === 'open');
            if (openChecks.length === 0) return "No open checklists.";
            openChecks.slice(0, 3).forEach(c => {
                summary.push(`- ${c.title} (${c.items.length} items)`); // Use items.length
            });
            if (openChecks.length > 3) summary.push(`... and ${openChecks.length - 3} more open lists.`);
            return summary.join('\n');
        }

        // Helper 3: Budget (Overview/Cost per day)
        function buildBudgetSummary() {
            let summary = [];
            if (appData.budget.length === 0) return "No active budgets to track.";
            appData.budget.forEach(b => {
                const days = daysLeft(b.endDate);
                const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
                if (days > 0 && costPerDay > 0) {
                    summary.push(`- ${b.title}: ‚Çπ${costPerDay}/day for ${days} days`);
                }
            });
            return summary.length > 0 ? summary.join('\n') : "No active budget overview available.";
        }

        // The single, correct checkNotifications function using registration.showNotification()
        async function checkNotifications(){
          showMoonPhaseNotification();
          if(!(Notification && Notification.permission === 'granted')) {
             console.log("Global notification permission not granted. Skipping custom checks.");
             return;
          }

          const registration = await navigator.serviceWorker.getRegistration();
          if (!registration) {
             console.warn("Service Worker not registered. Cannot show persistent notifications via SW.");
             // Fallback to non-persistent notification if SW isn't ready (less reliable on Android)
             // If permission granted, show a basic one
             if (Notification.permission === 'granted') {
                new Notification("Nothing Reminder", { body: "Checking reminders..." });
             }
             return;
          }

          // REMINDERS Summary
          if (appData.notifReminders) {
              const reminderSummary = buildReminderSummary();
              if (reminderSummary !== "No reminders due today/tomorrow.") {
                  registration.showNotification("Nothing Reminder - ‚ö†Ô∏è Reminders", {
                      body: reminderSummary, icon: 'assets/icon.png', requireInteraction: true, tag: 'reminders'
                  });
              }
          }

          // CHECKLIST Summary
          if (appData.notifChecklist) {
              const checklistSummary = buildChecklistSummary();
              if (checklistSummary !== "No open checklists.") {
                   registration.showNotification("Nothing Reminder - ‚úí Checklists", {
                      body: checklistSummary, icon: 'assets/icon.png', requireInteraction: true, tag: 'checklists'
                  });
              }
          }

         // ---------------- BUDGET NOTIFICATION FIX ----------------
          if (appData.notifBudget && appData.budget.length) {
            
            appData.budget.forEach(async (b) => {
          
              const registration = await navigator.serviceWorker.getRegistration();
              if (!registration) return;
          
              // Correct used amount
              const used = b.expenses
                ? b.expenses.reduce((sum, e) => sum + Number(e.amount), 0)
                : 0;
          
              // Correct remaining amount
              const remaining = Number(b.amount) - used;
          
              // Correct dynamic days left
              const days = b.endDate ? daysLeft(b.endDate) : null;
          
              // Correct per-day calculation
              const perDay = (days && days > 0)
                  ? (remaining / days).toFixed(2)
                  : remaining;
          
              // Build notification body
              const body = 
                `Budget: ${b.title}
                Total: ‚Çπ${b.amount}
                Used: ‚Çπ${used}
                Remaining: ‚Çπ${remaining}
                Per Day: ‚Çπ${perDay}
                Days Left: ${days !== null ? days : "N/A"}`;
          
              // SHOW NOTIFICATION
              registration.showNotification("üí∞ Budget Tracker Update", {
                body: body,
                icon: "assets/icon.png",
                tag: "budget-tracker-update",
              });
          
            });
          }
          // NOTES Summary
          if (appData.notifNotes) {
              const notesSummary = buildNotesSummary();
              if (notesSummary !== "No notes added yet.") {
                  registration.showNotification("Nothing Reminder - üìù Notes", {
                      body: notesSummary, icon: 'assets/icon.png', requireInteraction: true, tag: 'notes'
                  });
              }
          }
        }

        // ---------- Calculation History Functions ----------
                function renderHistory() {
                  const list = byId('calculationHistoryList');
                  list.innerHTML = '';
                  if (appData.calculationHistory.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No calculation history yet.';
                    li.style.opacity = '0.7';
                    list.appendChild(li);
                    return;
                  }

                  const frag = document.createDocumentFragment();
                  appData.calculationHistory.forEach((item, i) => {
                    const li = document.createElement('li');
                    const left = document.createElement('div');
                    left.className = 'item-left';

                    const title = document.createElement('div');
                    title.innerHTML = `<b>${item.title}</b>`;
                    title.style.fontWeight = '600';

                    const details = document.createElement('div');
                    details.style.fontSize = '13px';
                    details.style.opacity = '0.85';
                    details.textContent = `${item.result} | ${item.createdAt}`;

                    left.appendChild(title);
                    left.appendChild(details);

                    const right = document.createElement('div');
                    right.style.display = 'flex';
                    right.style.alignItems = 'center';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-small';
                    editBtn.textContent = '‚úèÔ∏è';
                    editBtn.title = 'Edit Title';
                    editBtn.addEventListener('click', () => editHistory(i));

                    const delBtn = document.createElement('button');
                    delBtn.className = 'icon-small';
                    delBtn.textContent = 'üóëÔ∏è';
                    delBtn.title = 'Delete';
                    delBtn.addEventListener('click', () => deleteHistory(i));

                    right.appendChild(editBtn);
                    right.appendChild(delBtn);
                    li.appendChild(left);
                    li.appendChild(right);
                    frag.appendChild(li);
                  });
                  list.appendChild(frag);
                }

                function saveHistory(result) {
                  const title = 'New Calculation';
                  if (title) {
                    const historyObj = {
                      title: title,
                      result: result,
                      createdAt: formatDateDMYWithTime(new Date())
                    };
                    appData.calculationHistory.push(historyObj);
                    saveAll();
                    renderHistory();
                  }
                }

                function editHistory(index) {
                  const item = appData.calculationHistory[index];
                  const newTitle = prompt('Edit title:', item.title);
                  if (newTitle) {
                    item.title = newTitle;
                    saveAll();
                    renderHistory();
                  }
                }


                // ---------- Normal Calculator Logic ----------
                let currentExpression = '0';
                const normalDisplay = byId('normalDisplay');

                function updateNormalDisplay(value) {
                  if (value === 'clear') {
                    currentExpression = '0';
                  } else if (value === 'backspace') {
                    currentExpression = currentExpression.length > 1 ? currentExpression.slice(0, -1) : '0';
                  } else if (value === 'equals') {
                    try {
                      // Safely evaluate the expression
                      // eslint-disable-next-line no-eval
                      const result = eval(currentExpression);
                      saveHistory(`${currentExpression} = ${result}`);
                      currentExpression = String(result);
                    } catch (e) {
                      currentExpression = 'Error';
                    }
                  } else {
                    if (currentExpression === '0' && value !== '.') {
                      currentExpression = value;
                    } else {
                      currentExpression += value;
                    }
                  }
                  normalDisplay.value = currentExpression;
                }

                document.querySelectorAll('.normal-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                    updateNormalDisplay(btn.dataset.value);
                  });
                });

                // ---------- Age Calculator Logic ----------
                function calculateAge() {
                  const dobStr = byId('dobInput').value;
                  const asOfStr = byId('asOfDateInput').value || new Date().toISOString().split('T')[0]; // Default to today
                  const resultEl = byId('ageResult');

                  if (!dobStr) {
                    resultEl.textContent = 'Please enter a date of birth.';
                    return;
                  }

                  const dob = new Date(dobStr);
                  const asOf = new Date(asOfStr);

                  let age_years = asOf.getFullYear() - dob.getFullYear();
                  let age_months = asOf.getMonth() - dob.getMonth();
                  let age_days = asOf.getDate() - dob.getDate();

                  if (age_days < 0) {
                    age_months--;
                    age_days += new Date(asOf.getFullYear(), asOf.getMonth(), 0).getDate(); // Days in the previous month
                  }
                  if (age_months < 0) {
                    age_years--;
                    age_months += 12;
                  }

                  const result = `Age as of ${formatDMY(asOfStr)}: ${age_years} years, ${age_months} months, and ${age_days} days.`;
                  resultEl.textContent = result;

                  saveHistory(`Age as of: ${age_years} years & ${age_months} months, & ${age_days} days.`, result);
                }

                // ---------- Date Difference Calculator Logic ----------
                function calculateDateDifference() {
                  const startStr = byId('dateDiffStart').value;
                  const endStr = byId('dateDiffEnd').value;
                  const resultEl = byId('dateDiffResult');

                  if (!startStr || !endStr) {
                    resultEl.textContent = 'Please enter both start and end dates.';
                    return;
                  }
                   const start = new Date(startStr);
               const end = new Date(endStr);
              const diffTime = Math.abs(end - start);
               const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)+1);

              // Calculate months and remaining days
              const totalMonths = Math.floor(diffDays / 30); // Approximate month as 30 days
              const remainingDays = diffDays % 30;
  
              let result;
              if (diffDays > 31) {
                result = `${totalMonths} month(s) and ${remainingDays} day(s)`;
              } else {
                result = `${diffDays} day(s)`;
              }
  
              saveHistory(`Date Difference: ${formatDMY(startStr)} to ${formatDMY(endStr)} = ${result}`, result);
                  }
                // ---------- BMI Calculator Logic ----------
                function calculateBMI() {
                  const age = parseInt(byId('bmiAge').value);
                  const height = parseFloat(byId('bmiHeight').value);
                  const weight = parseFloat(byId('bmiWeight').value);
                  const resultEl = byId('bmiResult');
                
                  if (!age || !height || !weight) {
                    resultEl.textContent = '‚ö†Ô∏è Please fill all fields.';
                    return;
                  }
                
                  // Calculate BMI
                  const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
                
                  // Determine category
                  let category = '';
                  if (bmi < 18.5) category = 'Underweight';
                  else if (bmi < 25) category = 'Normal';
                  else if (bmi < 30) category = 'Overweight';
                  else category = 'Obese';
                
                  // Include age relevance
                  let ageNote = '';
                  if (age < 18 && bmi > 24) ageNote = '‚ö†Ô∏è For children/teens, consult pediatric BMI charts.';
                  else if (age >= 18 && bmi > 24.9) ageNote = '‚ö†Ô∏è High for adult. Consider healthy diet/exercise.';
                
                  resultEl.textContent = `BMI: ${bmi} (${category}) ${ageNote}`;
                
                  // Save BMI history to appData
                  const historyObj = {
                    title: `BMI Result`,
                    result: `Age: ${age} | Height: ${height}cm | Weight: ${weight}kg | BMI: ${bmi} (${category})`,
                    createdAt: formatDateDMYWithTime(new Date())
                  };
                  if (!appData.calculationHistory) appData.calculationHistory = [];
                  appData.calculationHistory.push(historyObj);
                  saveAll();
                  renderHistory();
                }
                
                byId('calcBMIButton').addEventListener('click', calculateBMI);

                // ---------- Calculator Mode Switcher ----------
                function switchCalculatorMode() {
                  const mode = byId('calculatorMode').value;
                  document.querySelectorAll('.calculator-mode').forEach(el => el.classList.add('hidden'));

                  if (mode === 'normal') {
                    byId('normalCalculator').classList.remove('hidden');
                  } else if (mode === 'age') {
                    byId('ageCalculator').classList.remove('hidden');
                  } else if (mode === 'date') {
                    byId('dateCalculator').classList.remove('hidden');
                  }
                    else if (mode === 'bmi') {
                    byId('bmiCalculator').classList.remove('hidden');
                  }
                    else if (mode === "eb") {
                    document.getElementById("ebCalculator").classList.remove("hidden");
                    renderEbTable(); // Load editable tariff table
                }
                  // Reset history index when mode changes
                  editingHistoryIndex = null;
                  }

                // ---------- Monthly Calendar Logic ----------
                function renderCalendar(month, year) {
                  const today = new Date();
                  const grid = byId('calendarGrid');
                  const monthYearHeader = byId('currentMonthYear');
                  grid.innerHTML = '<div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>'; // Weekday headers

                  const date = new Date(year, month);
                  monthYearHeader.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                  const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
                  const daysInMonth = new Date(year, month + 1, 0).getDate();

                  // Add spacer days for the start of the month
                  for (let i = 0; i < firstDayOfMonth; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'calendar-day spacer';
                    grid.appendChild(spacer);
                  }

                  // Add days of the month
                  for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;

                    // Highlight today
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                      dayEl.classList.add('today');
                    }

                    grid.appendChild(dayEl);
                  }
                }

                function changeMonth(delta) {
                    currentMonth += delta;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    } else if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar(currentMonth, currentYear);
                }
                               // ---------- MOON PHASE FEATURE ----------
                const moonToggle = document.getElementById('moonPhaseToggle');
                const moonContainer = document.getElementById('moonPhaseContainer');
                
                moonToggle.addEventListener('click', () => {
                  moonContainer.classList.toggle('visible');
                  if (moonContainer.classList.contains('visible')) {
                    renderMoonPhases();
                  }
                });
                
                function renderMoonPhases() {
                  const now = new Date();
                  const year = now.getFullYear();
                  const month = now.getMonth();
                  const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                  moonContainer.innerHTML = `<h3>üåô ${now.toLocaleString('default', { month: 'long' })} ${year} ‚Äì Moon Phases</h3>`;
                
                  for (let d = 1; d <= daysInMonth; d++) {
                    const phaseName = getMoonPhase(year, month, d);
                    const tamilName = tamilPhase(phaseName);
                    const emoji = moonEmoji(phaseName);
                    const div = document.createElement('div');
                    div.className = 'moon-day';
                    div.innerHTML = `<span>${d}/${month + 1}/${year}</span><span>${phaseName} (${tamilName}) ${emoji}</span>`;
                    moonContainer.appendChild(div);
                  }
                }
                
                // Simple moon-phase algorithm
                function getMoonPhase(y, m, d) {
                  const lp = 2551443;
                  const new_moon = new Date(1970, 0, 7, 20, 35, 0);
                  const phase = ((new Date(y, m, d).getTime() - new_moon.getTime()) / 1000) % lp;
                  const index = Math.floor((phase / lp) * 8 + 0.5) % 8;
                  const names = [
                    "New Moon",
                    "Waxing Crescent",
                    "First Quarter",
                    "Waxing Gibbous",
                    "Full Moon",
                    "Waning Gibbous",
                    "Last Quarter",
                    "Waning Crescent"
                  ];
                  return names[index];
                }
                
                function tamilPhase(eng) {
                  switch (eng) {
                    case "New Moon": return "‡ÆÖ‡ÆÆ‡Ææ‡Æµ‡Ææ‡Æö‡Øà (Amavasai)";
                    case "Waxing Crescent": return "‡Æ™‡Æø‡Æ±‡Øà (Pirai)";
                    case "First Quarter": return "‡ÆÖ‡Æ∞‡Øà‡Æï‡Øç‡Æï‡Æ§‡Æø‡Æ∞‡Øç (Araikathir)";
                    case "Waxing Gibbous": return "‡Æ™‡Øå‡Æ∞‡Øç‡Æ£‡ÆÆ‡Æø ‡Æ®‡ØÜ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≤‡Øç (Pournami Nerungal)";
                    case "Full Moon": return "‡Æ™‡Øå‡Æ∞‡Øç‡Æ£‡ÆÆ‡Æø (Pournami)";
                    case "Waning Gibbous": return "‡ÆÆ‡Æ±‡Øà‡Æµ‡Æø‡Æ±‡Øà (Maraivirai)";
                    case "Last Quarter": return "‡ÆÖ‡Æ∞‡Øà ‡ÆÖ‡ÆÆ‡Øà‡Æ§‡Æø (Arai Amaithi)";
                    case "Waning Crescent": return "‡Æ§‡Øá‡ÆØ‡Øç‡Æ™‡Æø‡Æ±‡Øà (Theipirai)";
                    default: return "";
                  }
                }
                
                function moonEmoji(eng) {
                  const icons = {
                    "New Moon": "üåë",
                    "Waxing Crescent": "üåí",
                    "First Quarter": "üåì",
                    "Waxing Gibbous": "üåî",
                    "Full Moon": "üåï",
                    "Waning Gibbous": "üåñ",
                    "Last Quarter": "üåó",
                    "Waning Crescent": "üåò"
                  };
                  return icons[eng] || "üåô";
                }
                function getTodayPhase() {
                const now = new Date();
                const phase = getMoonPhase(now.getFullYear(), now.getMonth(), now.getDate());
            
                if (phase === "Full Moon") return "pournami";
                if (phase === "New Moon") return "amavasai";
                return "none";
                }
                // TAMIL MONTH DATA (STATIC RANGE)
                const tamilMonths = [
                  { name: "‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà",   start: "04-14", end: "05-14", info: "On This Month Tamil New Year, Chitra Pournami" },
                  { name: "‡Æµ‡Øà‡Æï‡Ææ‡Æö‡Æø",    start: "05-15", end: "06-14", info: "On This Month Vaikasi Visakam" },
                  { name: "‡ÆÜ‡Æ©‡Æø",       start: "06-15", end: "07-16", info: "On This Month Aani Thirumanjanam" },
                  { name: "‡ÆÜ‡Æü‡Æø",       start: "07-17", end: "08-16", info: "On This Month Aadi Perukku, Aadi Amavasai" },
                  { name: "‡ÆÜ‡Æµ‡Æ£‡Æø",     start: "08-17", end: "09-16", info: "On This Month Avani Avittam" },
                  { name: "‡Æ™‡ØÅ‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æö‡Æø", start: "09-17", end: "10-16", info: "On This Month Purattasi Saturdays" },
                  { name: "‡Æê‡Æ™‡Øç‡Æ™‡Æö‡Æø",    start: "10-17", end: "11-15", info: "On This Month Deepavali" },
                  { name: "‡Æï‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øà", start: "11-16", end: "12-15", info: "On This Month Karthigai Deepam" },
                  { name: "‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æï‡Æ¥‡Æø",   start: "12-16", end: "01-13", info: "On This Month Tiruppavai, Thiruvempavai" },
                  { name: "‡Æ§‡Øà",        start: "01-14", end: "02-12", info: "On This Month Pongal, Thai Poosam" },
                  { name: "‡ÆÆ‡Ææ‡Æö‡Æø",      start: "02-13", end: "03-13", info: "On This Month Maasi Magam" },
                  { name: "‡Æ™‡Æô‡Øç‡Æï‡ØÅ‡Æ©‡Æø",   start: "03-14", end: "04-13", info: "On This Month Panguni Uthiram" }
                ];
                
                // FUNCTION ‚Äî Returns current Tamil month object
                function getCurrentTamilMonth() {
                  const today = new Date();
                  const mmdd = (today.getMonth() + 1).toString().padStart(2,'0') + '-' +
                               today.getDate().toString().padStart(2,'0');
                
                  for (let m of tamilMonths) {
                    // Months crossing next year boundary (Margazhi)
                    if (m.start > m.end) {
                      if (mmdd >= m.start || mmdd <= m.end) return m;
                    }
                    // Normal month range
                    if (mmdd >= m.start && mmdd <= m.end) return m;
                  }
                  return null;
                }
                
                // DISPLAY CURRENT TAMIL MONTH
                function formatDM(md) {
                  const [mm, dd] = md.split('-');
                  return dd + '-' + mm;
                }
                
                function renderCurrentTamilMonth() {
                  const m = getCurrentTamilMonth();
                  const box = document.getElementById("currentTamilMonthText");
                
                  if (!m) {
                    box.textContent = "Unable to detect Tamil month.";
                    return;
                  }
                
                  box.innerHTML = `
                    <b>${m.name}</b><br>
                    <small>${formatDM(m.start)} ‚Üí ${formatDM(m.end)}</small><br>
                    <span style="opacity:0.8;">${m.info}</span>
                  `;
                }
                // Run immediately when opening Utilities page
                renderCurrentTamilMonth();

                // ---------------- SUNRISE / SUNSET ----------------
                document.getElementById("sunBtn").addEventListener("click", () => {
                  let box = document.getElementById("sunBox");
                  box.classList.toggle("visible");
                  if (box.classList.contains("visible")) showSunrise();
                });
                
                // Popular Indian Cities
                const CITY = {
                  kanyakumari:{lat:8.0883, lng:77.5385},
                  chennai:{lat:13.0827, lng:80.2707},
                  madurai:{lat:9.9252, lng:78.1198},
                  coimbatore:{lat:11.0168, lng:76.9558},
                  trichy:{lat:10.7905, lng:78.7047},
                  tirunelveli:{lat:8.7139, lng:77.7567},
                  pondicherry:{lat:11.9416, lng:79.8083},
                  bengaluru:{lat:12.9716, lng:77.5946},
                  mumbai:{lat:19.0760, lng:72.8777},
                  delhi:{lat:28.7041, lng:77.1025}
                };
                
                // City selection
                document.getElementById("sunCity").addEventListener("change", () => {
                  let v = sunCity.value;
                  document.getElementById("customInputs").style.display =
                    v === "custom" ? "block" : "none";
                  showSunrise();
                });
                
                // ------- Main Calculation -------
                function showSunrise() {
                  const city = document.getElementById("sunCity").value;
                  const result = document.getElementById("sunResult");
                  let lat, lng;
                
                  if (city === "custom") {
                    lat = parseFloat(document.getElementById("latInput").value);
                    lng = parseFloat(document.getElementById("lngInput").value);
                
                    if (!lat || !lng) {
                      result.innerHTML = "Enter Latitude & Longitude";
                      return;
                    }
                  } else {
                    lat = CITY[city].lat;
                    lng = CITY[city].lng;
                  }
                
                  const today = new Date();
                  const rise = calcSun(true, today, lat, lng);
                  const set = calcSun(false, today, lat, lng);
                
                  result.innerHTML = `
                    üìç <b>${cityName(city)}</b><br>
                    üåÖ <b>Sunrise:</b> ${rise}<br>
                    üåá <b>Sunset:</b> ${set}
                  `;
                }
                
                function cityName(c) {
                  if (c === "custom") return "Custom Location";
                  return c.charAt(0).toUpperCase() + c.slice(1);
                }
                
                // -------- NOAA Algorithm (Offline) --------
                function calcSun(isRise, date, lat, lng){
                  const rad = Math.PI/180;
                
                  let N = date.getDate();
                  for(let m=0;m<date.getMonth();m++){
                    N += [31,28+(isLeap(date.getFullYear())?1:0),31,30,31,30,31,31,30,31,30,31][m];
                  }
                
                  let lngHour = lng / 15;
                  let t = isRise ? N + (6 - lngHour)/24 : N + (18 - lngHour)/24;
                
                  let M = (0.9856*t) - 3.289;
                  let L = M + (1.916*Math.sin(rad*M)) + (0.020*Math.sin(rad*2*M)) + 282.634;
                  L = (L + 360) % 360;
                
                  let RA = Math.atan(0.91764*Math.tan(rad*L)) / rad;
                  RA = (RA + 360) % 360;
                
                  let Lquadrant  = Math.floor(L/90)*90;
                  let RAquadrant = Math.floor(RA/90)*90;
                  RA = RA + (Lquadrant - RAquadrant);
                  RA /= 15;
                
                  let sinDec = 0.39782 * Math.sin(rad*L);
                  let cosDec = Math.cos(Math.asin(sinDec));
                  let cosH = (Math.cos(rad*90.833) - sinDec*Math.sin(rad*lat)) / (cosDec*Math.cos(rad*lat));
                
                  if (cosH > 1) return "Sun doesn't rise";
                  if (cosH < -1) return "Sun doesn't set";
                
                  let H = isRise ? 360 - Math.acos(cosH)/rad : Math.acos(cosH)/rad;
                  H /= 15;
                
                  let T = H + RA - (0.06571*t) - 6.622;
                  let UT = (T - lngHour + 24) % 24;
                
                  let IST = UT + 5.5;
                  return formatTime(IST);
                }
                
                function isLeap(y){ return (y%4===0 && y%100!==0) || y%400===0; }
                
                function formatTime(dec){
                  let h = Math.floor(dec);
                  let m = Math.round((dec - h)*60);
                  if(m===60){h++;m=0;}
                  let ampm = h>=12 ? "PM" : "AM";
                  if(h>12) h-=12;
                  return `${h}:${m.toString().padStart(2,"0")} ${ampm}`;
                }
                // ---------------- TRASH BIN ----------------
                function moveToTrash(type, item, index) {
                  appData.trash.push({ type, item, deletedAt: new Date().toISOString() });
                  appData[type].splice(index, 1);
                  saveAll();
                  renderTrash();
                  rerenderFor(type); // ‚üµ live update the source page + home widgets
                }
                
                function restoreFromTrash(i){
                  const t = appData.trash[i];
                  if(!t) return;
                
                  // put back in its collection
                  if (Array.isArray(appData[t.type])) {
                    appData[t.type].push(t.item);
                  }
                
                  // remove from trash + persist
                  appData.trash.splice(i,1);
                  saveAll();
                
                  // live re-render destination page + home widgets
                  rerenderFor(t.type);
                  renderTrash();
                  if (t.type === 'calculationHistory' || t.type === 'utilities') {
                    if (typeof renderHistory === 'function') renderHistory();
                    const utilitiesPage = document.getElementById('utilities');
                    if (utilitiesPage) {
                      showPage('utilities');
                    }
                  
                    // Optional: scroll to bottom of Utilities history smoothly
                    setTimeout(() => {
                      const list = document.getElementById('calculationHistoryList');
                      if (list) list.scrollTop = list.scrollHeight;
                    }, 300);
                  
                    return; // stop further navigation so it doesn‚Äôt jump to wrong section
                  }
                  // optional UX: jump to the restored item's page
                  const targetPageId = (t.type === 'checklists') ? 'Check' : t.type;
                  if (document.getElementById(targetPageId)) {
                    showPage(targetPageId);
                  }
                }
                // New delete versions
                function deleteReminder(i){ moveToTrash('reminders', appData.reminders[i], i); renderReminders(); renderHomeReminders(); }
                function deleteNote(i){ moveToTrash('notes', appData.notes[i], i); renderNotes(); renderHomeNotes(); }
                function deleteBudget(i){ moveToTrash('budget', appData.budget[i], i); renderBudgets(); renderHomeBudgets(); }
                 // make global so inline onclick="" can find them
                window.editExpense = function(bIndex, expIndex) {
                  const exp = appData.budget[bIndex].expenses[expIndex];
                  if(!exp) return alert('Expense not found.');
                
                  const newTitle = prompt("Edit expense title:", exp.title);
                  if (newTitle === null) return; // cancelled
                
                  const newAmtStr = prompt("Edit amount (numbers only):", exp.amount);
                  if (newAmtStr === null) return; // cancelled
                  const newAmt = Number(newAmtStr);
                  if (isNaN(newAmt)) return alert('Enter a valid number.');
                
                  appData.budget[bIndex].expenses[expIndex] = {
                    ...exp,
                    title: newTitle.trim(),
                    amount: newAmt
                  };
                
                  saveAll();
                  renderBudgets();
                  renderHomeBudgets();
                };
                
                window.deleteExpense = function(bIndex, expIndex) {
                  const b = appData.budget[bIndex];
                  if(!b || !Array.isArray(b.expenses) || !b.expenses[expIndex]) {
                    return alert('Expense not found.');
                  }
                  b.expenses.splice(expIndex, 1);
                  saveAll();
                  renderBudgets();
                  renderHomeBudgets();
                };
                
                // event delegation for expense edit/delete
                document.querySelectorAll('.edit-exp').forEach(btn => {
                  btn.addEventListener('click', (ev) => {
                    const b = Number(btn.dataset.b), e = Number(btn.dataset.e);
                    editExpense(b, e); // can be inner or window function
                  });
                });
                document.querySelectorAll('.del-exp').forEach(btn => {
                  btn.addEventListener('click', (ev) => {
                    const b = Number(btn.dataset.b), e = Number(btn.dataset.e);
                    deleteExpense(b, e);
                  });
                });
                function deleteCheck(i){ moveToTrash('checklists', appData.checklists[i], i); renderChecklists(); renderHomeCheck(); }
                function deleteHistory(i){moveToTrash('calculationHistory', appData.calculationHistory[i], i); renderHistory(); }
                                // ---------- Event Listeners ----------
                // Utilities Listeners
                byId('monthlyCalendarToggle').addEventListener('click', function() {
                  toggleCollapse(byId('monthlyCalendarContainer'), byId('monthlyCalendarToggle'));
                  renderCalendar(currentMonth, currentYear); // Render on opening
                });
                byId('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
                byId('nextMonthBtn').addEventListener('click', () => changeMonth(1));

                byId('calculatorToggle').addEventListener('click', function() {
                  toggleCollapse(byId('calculatorContainer'), byId('calculatorToggle'));
                });
                byId('calculatorMode').addEventListener('change', switchCalculatorMode);

                byId('calculateAgeBtn').addEventListener('click', calculateAge);
                byId('calculateDateDiffBtn').addEventListener('click', calculateDateDifference);

                byId('viewHistoryToggle').addEventListener('click', function() {
                  toggleCollapse(byId('calculationHistoryList'), byId('viewHistoryToggle'));
                });
                // ... all other listeners ...

                // Notification Page Listener
                byId('requestPermissionBtn').addEventListener('click', requestNotificationPermission);
                byId('toggleReminders').addEventListener('change', (e) => handleCustomNotifToggle('notifReminders', e));
                byId('toggleNotes').addEventListener('change', (e) => handleCustomNotifToggle('notifNotes', e));
                byId('toggleChecklist').addEventListener('change', (e) => handleCustomNotifToggle('notifChecklist', e));
                byId('toggleBudget').addEventListener('change', (e) => handleCustomNotifToggle('notifBudget', e));

                byId('showAddFormBtn').addEventListener('click', function() {
                  toggleCollapse(byId('reminderFormContainer'), byId('showAddFormBtn'));
                });

                byId('cancelReminderBtn').addEventListener('click', function() {
                  hideForm(byId('reminderFormContainer'));
                  editingIndex=null;
                  clearReminderForm();
                });

                byId('saveReminderBtn').addEventListener('click', saveReminder);
                byId('viewRemindersToggle').addEventListener('click', function() {
                  toggleCollapse(byId('reminderList'), byId('viewRemindersToggle'));
                });

                // Notes Listeners
                byId('showAddNoteBtn').addEventListener('click', function() {
                  byId('saveNoteBtn').textContent = 'Save'; // Ensure it says Save
                  toggleCollapse(byId('noteFormContainer'), byId('showAddNoteBtn'));
                });

                byId('cancelNoteBtn').addEventListener('click', function() {
                  hideForm(byId('noteFormContainer'));
                  editingNoteIndex = null;
                  byId('saveNoteBtn').textContent = 'Save';
                });

                byId('saveNoteBtn').addEventListener('click', saveNote);

                byId('viewNotesToggle').addEventListener('click', function() {
                  toggleCollapse(byId('noteList'), byId('viewNotesToggle'));
                });

                byId('homeRemindersToggle').addEventListener('click', function() {
                  toggleCollapse(byId('homeRemindersContainer'), byId('homeRemindersToggle'));
                });

                byId('homeNotesToggle').addEventListener('click', function() {
                  toggleCollapse(byId('homeNotesContainer'), byId('homeNotesToggle'));
                });

                byId('homeCheckToggle').addEventListener('click', function() {
                  toggleCollapse(byId('homeCheckContainer'), byId('homeCheckToggle'));
                });
                byId('homeOverviewToggle').addEventListener('click', function() {
                  toggleCollapse(byId('homeOverviewContainer'), byId('homeOverviewToggle'));
                });
                byId('showAddBudgetBtn').addEventListener('click', function() {
                  toggleCollapse(byId('budgetFormContainer'), byId('showAddBudgetBtn'));
                });

                byId('cancelBudgetBtn').addEventListener('click', function() {
                  hideForm(byId('budgetFormContainer'));
                  editingBudgetIndex=null;
                  clearBudgetForm();
                });

                byId('saveBudgetBtn').addEventListener('click', saveBudget);
                byId('viewbudgetToggle').addEventListener('click', function() {
                  toggleCollapse(byId('budgetList'), byId('viewbudgetToggle'));
                });
                byId('homeBudgetsToggle').addEventListener('click', function() {
                  toggleCollapse(byId('homeBudgetsContainer'), byId('homeBudgetsToggle'));
                });

                // Check List Event Listeners
                byId('showAddCheckBtn').addEventListener('click', function() {
                  toggleCollapse(byId('checkFormContainer'), byId('showAddCheckBtn'));
                });

                byId('cancelCheckBtn').addEventListener('click', function() {
                  hideForm(byId('checkFormContainer'));
                  editingCheckIndex = null;
                  byId('saveCheckBtn').textContent = 'Save';
                });

                byId('saveCheckBtn').addEventListener('click', saveCheck);

                byId('viewCheckToggle').addEventListener('click', function() {
                  toggleCollapse(byId('checkList'), byId('viewCheckToggle'));
                });

                document.querySelectorAll('.menu-btn[data-page]').forEach(btn=>{
                  btn.addEventListener('click',function() {
                    showPage(this.dataset.page);
                  });
                });

                function toggleCollapse(el, btn){
                  el.classList.toggle('visible');
                  btn.classList.toggle('open');
                }

                // ---------- Initial Render Code ----------

                // 1. Set initial UI states from loaded data
                if (appData.darkMode === '1') document.body.classList.add('dark');
                if (appData.profileName) profileNameEl.textContent = appData.profileName;
                if (appData.profilePhoto) byId('profilePhoto').src = appData.profilePhoto;

                // 2. Initial synchronous render of all data
                renderReminders();
                renderNotes();
                renderBudgets();
                renderChecklists();
                renderHistory(); // NEW: Initial render for history
                renderCalculationHistory()
                // NEW: Initialize calculator mode
                switchCalculatorMode();
                async function showMoonPhaseNotification() {
                    if (!appData.notifMoonPhase) return;
                    if (Notification.permission !== "granted") return;

                    const registration = await navigator.serviceWorker.getRegistration();
                    if (!registration) return;

                    const phase = getTodayPhase();

                    if (phase === "pournami") {
                        registration.showNotification("üåï Pournami Today!", {
                            body: "Full Moon (Pournami) is happening today.",
                            icon: "assets/icon.png",
                            requireInteraction: true,
                            tag: "moon-phase"
                        });
                    }
                    else if (phase === "amavasai") {
                        registration.showNotification("üåë Amavasai Today!", {
                            body: "New Moon (Amavasai) is today.",
                            icon: "assets/icon.png",
                            requireInteraction: true,
                            tag: "moon-phase"
                        });
                    }
                }
                // 3. Setup notifications
                // Notifications are now checked on page load (below) and on every data save (in saveAll).
                if ("Notification" in window) {
                    updateBrowserPermissionUI();
                    checkNotifications(); // Check once on page load
                }
              window.addEventListener('load', () => {
                if (!appData.trash) appData.trash = [];
                renderTrash();
                byId('emptyTrashBtn')?.addEventListener('click', emptyTrashAll);
              });
              // Ensure only Home is visible and sidebar is hidden on initial page load
              window.addEventListener('load', () => {
                const sidebar = document.getElementById('sidebar');
                const main = document.getElementById('main');
                const toggleBtn = document.getElementById('toggleBtn');
              
                // Hide sidebar off-screen (same positions your toggle uses)
                if (sidebar) sidebar.style.left = '-220px';
              
                // Make main area full width (no left margin)
                if (main) main.style.marginLeft = '0';
              
                // Hide all pages and then show only Home
                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                const home = document.getElementById('home');
                if (home) home.classList.remove('hidden');
              
                // Ensure Trash (and other widgets) render after load too
                if (typeof renderTrash === 'function') renderTrash();
              });
              // ---------- Storage Usage Feature (500 MB quota; clean display) ----------
              const viewStorageBtn = document.getElementById('viewStorageBtn');
              const storageBar = document.getElementById('storageBar');
              const storageText = document.getElementById('storageText');
              const storageEmoji = document.getElementById('storageEmoji');
              const barContainer = document.getElementById('storageBarContainer');
              if (!viewStorageBtn) return;
            
              viewStorageBtn.addEventListener('click', () => updateStorageUsage());
              window.addEventListener('load', () => setTimeout(updateStorageUsage, 80));
            
              function updateStorageUsage() {
                const usedBytes = getLocalStorageSize();
                const maxBytes = 500 * 1024 * 1024; // 500 MB quota
                const percent = Math.min((usedBytes / maxBytes) * 100, 100);
            
                // fill bar & color
                storageBar.style.width = percent.toFixed(1) + '%';
                if (percent < 80) storageBar.style.background = 'linear-gradient(90deg,#4caf50,#8bc34a)';
                else if (percent < 95) storageBar.style.background = 'linear-gradient(90deg,#ffb74d,#ff7043)';
                else storageBar.style.background = 'linear-gradient(90deg,#ff7043,#f44336)';
            
                // move üôà
                const cw = barContainer.clientWidth;
                const ew = 18;
                let left = (percent / 100) * cw - ew / 2;
                left = Math.max(0, Math.min(cw - ew, left));
                storageEmoji.style.left = left + 'px';
            
                // show only ‚ÄúX MB of 500 MB used‚Äù
                const usedMB = (usedBytes / 1024 / 1024).toFixed(2);
                storageText.textContent = `${usedMB} MB of 500 MB used`;
              }
            
              function getLocalStorageSize() {
                let total = 0;
                for (let i = 0; i < localStorage.length; i++) {
                  const key = localStorage.key(i);
                  const val = localStorage.getItem(key);
                  total += (key ? key.length : 0) + (val ? val.length : 0);
                }
                return total;
              }
              window.addEventListener('load', () => setTimeout(updateStorageUsage, 80));
              window.updateStorageUsage = updateStorageUsage;
             function renderHomeOverview() {
              // --- Reminders Count ---
              let activeRem = 0;
              let inactiveRem = 0;

              appData.reminders.forEach(r => {
                const diff = daysLeft(r.endDate);
                if (diff < 0) inactiveRem++;
                else activeRem++;
              });

              // --- Checklists Count ---
              let activeChk = 0;
              let inactiveChk = 0;

              appData.checklists.forEach(c => {
                if (c.status === "open") activeChk++;
                else inactiveChk++;
              });

              byId("activeRemindersCount").textContent = activeRem;
              byId("inactiveRemindersCount").textContent = inactiveRem;
              byId("activeChecklistsCount").textContent = activeChk;
              byId("inactiveChecklistsCount").textContent = inactiveChk;
            }
            /* ---------------- GOLD RATE OPTION A (GOOGLE FINANCE SPOT PRICE) ---------------- */
            (function(){
            
              const $ = id => document.getElementById(id);
            
              const toggleBtn = $("goldRateToggle");
              const formDiv   = $("goldRateForm");
              const place1Sel = $("goldPlace1");
              const place2Sel = $("goldPlace2");
              const statusEl  = $("goldStatus");
              const tablesEl  = $("goldTables");
              const refreshBtn = $("goldRefreshBtn");
            
              const SNAP = "gold_snap_google_v1";
            
              const PLACES = [
                "Chennai","Madurai","Coimbatore","Trichy","Tirunelveli","Kanyakumari",
                "Pondicherry","Salem","Erode","Vellore","Thanjavur","Nagercoil",
                "Dindigul","Tirupur","Karur","Kanchipuram","Chengalpattu",
                "Bengaluru","Kochi","Thiruvananthapuram","Calicut","Ernakulam",
                "Pune","Mumbai","Hyderabad"
              ];
            
              // city price difference calibration (to match GoodReturns)
              const CITY_ADJUST = {
                "Chennai": 0,
                "Madurai": 15,
                "Coimbatore": 12,
                "Trichy": 10,
                "Tirunelveli": 8,
                "Kanyakumari": 5,
                "Pondicherry": 3,
                "Salem": 4,
                "Erode": 5,
                "Vellore": 6,
                "Thanjavur": 7,
                "Nagercoil": 8,
                "Dindigul": 10,
                "Tirupur": 12,
                "Karur": 11,
                "Kanchipuram": 5,
                "Chengalpattu": 6,
                "Bengaluru": 20,
                "Kochi": -10,
                "Thiruvananthapuram": -8,
                "Calicut": -12,
                "Ernakulam": -10,
                "Pune": 18,
                "Mumbai": 22,
                "Hyderabad": 20
              };
            
              const load = k => {try{return JSON.parse(localStorage.getItem(k)||"{}")}catch(e){return{}}};
              const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
              const fmt = v => v==null ? "‚Äî" : "‚Çπ " + Math.round(Number(v)).toLocaleString("en-IN");
            
              // populate dropdowns
              (function(){
                PLACES.forEach(p=>{
                  const o1=document.createElement("option"); o1.value=p; o1.textContent=p;
                  const o2=document.createElement("option"); o2.value=p; o2.textContent=p;
                  place1Sel.appendChild(o1); place2Sel.appendChild(o2);
                });
                place2Sel.selectedIndex=1;
              })();
            
              /* ---------------- FETCH SPOT PRICE FROM GOOGLE FINANCE ---------------- */
            async function fetchSpotINR() {
            
                // 1) Fetch live gold per ounce in USD
                const goldRes = await fetch("https://data-asg.goldprice.org/dbXRates/USD");
                const goldData = await goldRes.json();
            
                if (!goldData.items || !goldData.items[0].xauPrice)
                    throw new Error("Live XAU price unavailable");
            
                const xauUSD = goldData.items[0].xauPrice;
            
                // 2) Fetch USD ‚Üí INR rate
                const fxRes = await fetch("https://open.er-api.com/v6/latest/USD");
                const fxData = await fxRes.json();
            
                if (!fxData.rates || !fxData.rates.INR)
                    throw new Error("INR rate unavailable");
            
                const usdToInr = fxData.rates.INR;
            
            
            function convertToIndianRetailPrice(base24_inr_per_gram) {
            
                let price = Number(base24_inr_per_gram);
            
                // 6% import duty
                price += price * 0.06;
            
                // 3% GST
                price += price * 0.03;
            
                // Dealer premium (tune 150‚Äì250)
                const dealerPremium = 180;
                price += dealerPremium;
            
                const retail24 = Math.round(price);
            
                return {
                    retail24k: retail24,
                    retail22k: Math.round(retail24 * 0.916),
                    retail18k: Math.round(retail24 * 0.750)
                };
            }
            
            
            const perGram24K = (xauUSD * usdToInr) / 31.1035; // 31.1035 grams in a troy ounce
            
            return Math.round(perGram24K);
            }
            
            
              /* ---------------- GENERATE PURITY VALUES ---------------- */
             function purityRates(spot, place){
                const adj = CITY_ADJUST[place] || 0; 
                
                // --- ADD THESE TWO LINES ---
                const RETAIL_MARKUP = 0.05; // 5% assumed for making charge/jeweler margin (adjust as needed)
                const GST_RATE = 0.03;      // 3% Goods and Services Tax 
                // ---------------------------
                
                // Gold rates per 10 grams for 24k (pure)
                const base = spot * 1;
                
                // --- CHANGE 'const' to 'let' for these three lines ---
                let rate24k = base + adj; 
                let rate22k = (base * 0.916) + adj;
                let rate18k = (base * 0.750) + adj;
                // ----------------------------------------------------
            
                // --- ADD THESE THREE LINES TO APPLY MARKUP AND GST ---
                // Retail Price = (Gold Price + Markup) + GST on the total
                rate24k = (rate24k * (1 + RETAIL_MARKUP)) * (1 + GST_RATE);
                rate22k = (rate22k * (1 + RETAIL_MARKUP)) * (1 + GST_RATE);
                rate18k = (rate18k * (1 + RETAIL_MARKUP)) * (1 + GST_RATE);
                // -----------------------------------------------------
            
               return {
                "18k": Math.round(rate18k),
                "22k": Math.round(rate22k),
                "24k": Math.round(rate24k),
                "place": place,
                "time": new Date().getTime(),
              }
              }
            
              /* ---------------- SAVE SNAPSHOT ---------------- */
              function saveSnap(place,data){
                const s = load(SNAP);
                const t = new Date().toISOString().slice(0,10);
                s[t] = s[t] || {};
                s[t][place] = data;
                save(SNAP,s);
              }
              function getYesterday(place){
                const s = load(SNAP);
                let d = new Date(); d.setDate(d.getDate()-1);
                const y = d.toISOString().slice(0,10);
                return s[y]?.[place] || null;
              }
            
              /* ---------------- BUILD TABLE ---------------- */
              function buildTable(place,t,y){
                const diff = (a, b) => {
                if (!a || !b) return "‚Äî";
                const change = Math.round(a - b);
                const sign = change > 0 ? "+" : "-";
                return `${sign}‚Çπ${Math.abs(change)}`;
              };

                return `
                  <div class="gold-table-wrapper">
                    <div style="border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:15px;background:#fff;">
                      <h3>${place}</h3>
                      <table style="width:100%;border-collapse:collapse;">
                        <tr style="background:#f3f3f3;font-weight:700;">
                          <td>Price</td><td>18K</td><td>22K</td><td>24K</td>
                        </tr>
                        <tr><td>Today</td><td>${fmt(t["18k"])}</td><td>${fmt(t["22k"])}</td><td>${fmt(t["24k"])}</td></tr>
                        <tr><td>Yesterday</td><td>${fmt(y?.["18k"])}</td><td>${fmt(y?.["22k"])}</td><td>${fmt(y?.["24k"])}</td></tr>
                        <tr><td>Change</td><td>${diff(t["18k"],y?.["18k"])}</td><td>${diff(t["22k"],y?.["22k"])}</td><td>${diff(t["24k"],y?.["24k"])}</td></tr>
                      </table>
                    </div>
                  </div>
                `;
              }
            
              /* ---------------- MAIN ---------------- */
              async function renderGold(){
                statusEl.innerHTML = "‚è≥ Fetching live spot price...";
            
                try{
                  const spot = await fetchSpotINR();
            
                  const p1 = place1Sel.value;
                  const p2 = place2Sel.value;
            
                  const r1 = purityRates(spot,p1);
                  const r2 = purityRates(spot,p2);
            
                  saveSnap(p1,r1);
                  saveSnap(p2,r2);
            
                  const y1 = getYesterday(p1);
                  const y2 = getYesterday(p2);
            
                  tablesEl.innerHTML =
                    buildTable(p1,r1,y1) +
                    buildTable(p2,r2,y2);
            
                  statusEl.innerHTML = "‚è≥ Almost Accurate Data Updated";
                }
                catch(e){
                  statusEl.innerHTML = "‚ùå Failed: "+e.message;
                }
              }
            
              /* ---------------- UI EVENTS ---------------- */
            
              toggleBtn.addEventListener("click",()=>{
                const exp = toggleBtn.getAttribute("aria-expanded")==="true";
                toggleBtn.setAttribute("aria-expanded",String(!exp));
                toggleBtn.classList.toggle("open");
                formDiv.classList.toggle("visible");
                if(!exp) renderGold();
              });
            
              place1Sel.addEventListener("change", renderGold);
              place2Sel.addEventListener("change", renderGold);
              refreshBtn.addEventListener("click", renderGold);
            
            })();
            /* ---------------- WEATHER FORECAST (TODAY & TOMORROW) ---------------- */
            (function(){
              const $ = id => document.getElementById(id);
            
              const toggleBtn = $("weatherToggle");
              const formDiv = $("weatherForm");
              const citySel = $("weatherCity");
              const statusEl = $("weatherStatus");
              const outEl = $("weatherOutput");
              const refreshBtn = $("weatherRefreshBtn");
            
              const CITIES = [
                "Chennai",
                "Madurai",
                "Coimbatore",
                "Trichy",
                "Tirunelveli",
                "Salem",
                "Erode",
                "Vellore",
                "Thanjavur",
                "Tanjore",
                "Tuticorin",
                "Tiruppur",
                "Kanyakumari",
                "Dindigul",
                "Karur",
                "Namakkal",
                "Kanchipuram",
                "Chengalpattu",
                "Cuddalore",
                "Villupuram",
                "Dharmapuri",
                "Krishnagiri",
                "Nagapattinam",
                "Sivagangai",
                "Ramanathapuram",
                "Tiruvarur",
                "Virudhunagar",
                "Nagercoil",
                "Perambalur",
                "Pudukkottai",
              ];
            
              // fill dropdown
              CITIES.forEach(c=>{
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                citySel.appendChild(o);
              });
            
              function getIcon(desc){
                const d = desc.toLowerCase();
                if(d.includes("sun") || d.includes("clear")) return "‚òÄÔ∏è";
                if(d.includes("cloud")) return "‚õÖ";
                if(d.includes("rain")) return "üåßÔ∏è";
                if(d.includes("storm") || d.includes("thunder")) return "‚õàÔ∏è";
                if(d.includes("fog")) return "üå´Ô∏è";
                if(d.includes("snow")) return "‚ùÑÔ∏è";
                return "‚õÖ";
              }
            
              async function fetchWeather(city){
              statusEl.textContent = "‚è≥ Fetching hourly forecast‚Ä¶";
            
              // 1) geocode the city (open-meteo geocoding)
              const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`;
              const gres = await fetch(geoUrl, { cache: 'no-store' });
              if(!gres.ok) throw new Error('Geocode failed');
              const gdata = await gres.json();
              const place = (gdata.results && gdata.results[0]);
              if(!place) throw new Error('City not found');
            
              const lat = place.latitude;
              const lon = place.longitude;
            
              // 2) prepare date range: today and tomorrow (ISO YYYY-MM-DD)
              const todayDate = new Date();
              const todayISO = todayDate.toISOString().slice(0,10);
              const tomorrowDate = new Date(todayDate);
              tomorrowDate.setDate(tomorrowDate.getDate()+1);
              const tomorrowISO = tomorrowDate.toISOString().slice(0,10);
              // fetch full 2-day hourly data (start today 00:00 -> end tomorrow 23:00)
              const start = todayISO;
              const end = tomorrowISO;
            
              // 3) fetch hourly forecast from Open-Meteo
              // request: temperature_2m, relativehumidity_2m, precipitation_probability, weathercode
              const params = [
                `latitude=${lat}`,
                `longitude=${lon}`,
                `hourly=temperature_2m,relativehumidity_2m,precipitation_probability,weathercode`,
                `start_date=${start}`,
                `end_date=${end}`,
                `timezone=Asia/Kolkata`
              ].join('&');
            
              const fUrl = `https://api.open-meteo.com/v1/forecast?${params}`;
              const fres = await fetch(fUrl, { cache: 'no-store' });
              if(!fres.ok) throw new Error('Forecast fetch failed');
              const fdata = await fres.json();
            
              // 4) normalize hourly arrays into objects keyed by ISO date-time 'YYYY-MM-DDTHH:MM'
              const times = fdata.hourly.time || []; // e.g. "2025-12-04T00:00"
              const temps = fdata.hourly.temperature_2m || [];
              const hums  = fdata.hourly.relativehumidity_2m || [];
              const precs = fdata.hourly.precipitation_probability || [];
              const wc    = fdata.hourly.weathercode || [];
            
              // build list of hourly entries
              const hourly = [];
              for(let i=0;i<times.length;i++){
                const tISO = times[i];                   // "YYYY-MM-DDTHH:MM"
                const dt = new Date(tISO);
                const hour24 = dt.getHours();            // 0..23 (local tz because we requested Asia/Kolkata)
                const date = tISO.slice(0,10);           // YYYY-MM-DD
                hourly.push({
                  date,
                  hour24,
                  timeISO: tISO,
                  temp: temps[i] != null ? Math.round(temps[i]) : null,
                  humidity: hums[i] != null ? Math.round(hums[i]) : null,
                  precipProb: precs[i] != null ? Math.round(precs[i]) : null,
                  weathercode: wc[i] != null ? wc[i] : null
                });
              }
            
              // 5) pick today's 0..23 and tomorrow's 0..23 arrays (ensures full 24 entries each)
              const todayHours = [];
              const tomorrowHours = [];
            
              for(let h=0; h<24; h++){
                // find hour entry for today date + hour h
                const tEntry = hourly.find(x => x.date === todayISO && x.hour24 === h) || {
                  date: todayISO, hour24: h, timeISO: `${todayISO}T${String(h).padStart(2,'0')}:00`, temp:null, humidity:null, precipProb:null, weathercode:null
                };
                todayHours.push(tEntry);
            
                const tmEntry = hourly.find(x => x.date === tomorrowISO && x.hour24 === h) || {
                  date: tomorrowISO, hour24: h, timeISO: `${tomorrowISO}T${String(h).padStart(2,'0')}:00`, temp:null, humidity:null, precipProb:null, weathercode:null
                };
                tomorrowHours.push(tmEntry);
              }
            
              // 6) map to UI-friendly format: time12, temp, rain, humidity, icon
              const getIconFromCodeOrProb = (entry) => {
                // If precipitation probability high -> rain; else use weathercode bands
                if(entry.precipProb != null && entry.precipProb >= 50) return 'üåßÔ∏è';
                const code = entry.weathercode;
                if(code === null || code === undefined) {
                  // fallback by temp/humidity
                  if(entry.temp != null && entry.temp >= 30) return '‚òÄÔ∏è';
                  return '‚õÖ';
                }
                // open-meteo weathercode mapping (simple)
                // 0 clear, 1-3 partly cloudy, 45/48 fog, 51-67 drizzle/rain, 71-77 snow, 95-99 thunder
                if(code === 0) return '‚òÄÔ∏è';
                if(code >= 1 && code <= 3) return '‚õÖ';
                if(code === 45 || code === 48) return 'üå´Ô∏è';
                if((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return 'üåßÔ∏è';
                if(code >= 71 && code <= 77) return '‚ùÑÔ∏è';
                if(code >= 95) return '‚õàÔ∏è';
                return '‚õÖ';
              };
            
              const to12 = (h) => {
                let hr = Number(h) % 24;
                const ampm = hr >= 12 ? 'PM' : 'AM';
                hr = hr % 12;
                if(hr === 0) hr = 12;
                return `${hr}:00 ${ampm}`;
              };
            
              const todayUI = todayHours.map(e => ({
                time12: to12(e.hour24),
                temp: e.temp,
                rain: e.precipProb,
                humidity: e.humidity,
                icon: getIconFromCodeOrProb(e)
              }));
            
              const tomorrowUI = tomorrowHours.map(e => ({
                time12: to12(e.hour24),
                temp: e.temp,
                rain: e.precipProb,
                humidity: e.humidity,
                icon: getIconFromCodeOrProb(e)
              }));
            
              // final normalized object
              return {
                cityResolved: place.name + (place.country ? (', ' + place.country) : ''),
                todayHours: todayUI,
                tomorrowHours: tomorrowUI
              };
            }
              function buildWeatherUI(city, w){
              const tableRows = arr => arr.map(h=>`
                <tr>
                  <td style="padding:6px 8px;width:14%">${h.time12}</td>
                  <td style="padding:6px 8px;width:8%;text-align:center">${h.icon}</td>
                  <td style="padding:6px 8px;width:24%;text-align:center">${h.temp==null?'‚Äî':h.temp+'¬∞C'}</td>
                  <td style="padding:6px 8px;width:24%;text-align:center">${h.rain==null?'‚Äî':h.rain+'%'}</td>
                  <td style="padding:6px 8px;width:24%;text-align:center">${h.humidity==null?'‚Äî':h.humidity+'%'}</td>
                </tr>
              `).join('');
            
              return `
                <div style="border:1px solid #ddd;border-radius:10px;padding:12px;background:#fff;">
                  <h3 style="margin:0 0 8px 0">${city} ‚Äî Hourly Forecast</h3>
            
                  <h4 style="margin:8px 0 6px 0;font-size:14px">TODAY</h4>
                  <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;">
                      <tr style="background:#f3f3f3;font-weight:700">
                        <td>Time</td><td style="text-align:center">Weather</td><td style="text-align:center">Temp</td><td style="text-align:center">Rain %</td><td style="text-align:center">Humidity</td>
                      </tr>
                      ${tableRows(w.todayHours)}
                    </table>
                  </div>
            
                  <h4 style="margin:12px 0 6px 0;font-size:14px">TOMORROW</h4>
                  <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;">
                      <tr style="background:#f3f3f3;font-weight:700">
                        <td>Time</td><td style="text-align:center">Icon</td><td style="text-align:center">Temp</td><td style="text-align:center">Rain %</td><td style="text-align:center">Humidity</td>
                      </tr>
                      ${tableRows(w.tomorrowHours)}
                    </table>
                  </div>
                </div>
              `;
            }
             async function renderWeather(){
              try{
                const city = citySel.value || citySel.options[0]?.value;
                statusEl.textContent = '‚è≥ Fetching hourly forecast...';
                const w = await fetchWeather(city);
                outEl.innerHTML = buildWeatherUI(w.cityResolved, w);
                statusEl.textContent = '‚úî Hourly forecast updated';
                // save last city for notifications if you use that
                localStorage.setItem('last_weather_city', city);
                // optionally save snapshot for offline fallback
                localStorage.setItem('weather_snapshot_' + new Date().toISOString().slice(0,10), JSON.stringify(w));
              } catch(err){
                console.error('Weather error', err);
                statusEl.textContent = '‚ùå Hourly forecast failed: ' + (err.message||'');
                outEl.innerHTML = `<div style="color:#d32f2f;padding:10px;border:1px solid #ffdede;border-radius:8px;">Failed to fetch hourly forecast.</div>`;
              }
            }
              toggleBtn.addEventListener("click", ()=>{
                const exp = toggleBtn.getAttribute("aria-expanded") === "true";
                toggleBtn.setAttribute("aria-expanded", !exp);
                toggleBtn.classList.toggle("open");
                formDiv.classList.toggle("visible");
                if(!exp) renderWeather();
              });
            
              refreshBtn.addEventListener("click", renderWeather);
              citySel.addEventListener("change", renderWeather);
            
            })();
            /* ==========================
             EB TAMIL NADU TARIFF SLABS
             USER EDITABLE
            ========================== */

            let ebSlabs = [
              { from: 1, to: 100, cost: 0 },
              { from: 101, to: 200, cost: 2.35 },
              { from: 201, to: 400, cost: 4.70 },
              { from: 401, to: 500, cost: 6.30 },
              { from: 501, to: 600, cost: 8.40 },
              { from: 601, to: 800, cost: 9.45 },
              { from: 801, to: 1000, cost: 10.50 },
              { from: 1001, to: Infinity, cost: 11.55 }
            ];
            
            /* Build editable tariff table */
              function renderEbTable() {
              const tbl = document.getElementById("ebTariffTable");
            
              tbl.innerHTML = `
                <tr style="background:#ddd; text-align:center;">
                  <th>From</th>
                  <th>To</th>
                  <th>‚Çπ Rate</th>
                </tr>
              `;
            
              ebSlabs.forEach((s, i) => {
                const row = document.createElement("tr");
            
                row.innerHTML = `
                  <td style="text-align:center; padding:8px;">${s.from}</td>
                  <td style="text-align:center; padding:6px;">${s.to === Infinity ? "‚àû" : s.to}</td>
                  <td style="text-align:center; padding:6px;">
                    <input type="number" 
                           id="slab_${i}" 
                           value="${s.cost}" 
                           style="width:80px;padding:4px;border-radius:6px;border:1px solid #aaa;text-align:center;">
                  </td>
                `;
            
                tbl.appendChild(row);
              });
            }
            
            byId("resetSlabs").addEventListener("click", () => {
              ebSlabs = [
                { from: 1, to: 100, cost: 0 },
                { from: 101, to: 200, cost: 2.35 },
                { from: 201, to: 400, cost: 4.70 },
                { from: 401, to: 500, cost: 6.30 },
                { from: 501, to: 600, cost: 8.40 },
                { from: 601, to: 800, cost: 9.45 },
                { from: 801, to: 1000, cost: 10.50 },
                { from: 1001, to: Infinity, cost: 11.55 }
              ];
              renderEbTable();
            });
            /* Calculate EB Amount */
            function calculateEbBill(units) {
              let total = 0;
            
              // update slab rates from user editable inputs
              ebSlabs.forEach((slab, i) => {
                const box = document.getElementById(`slab_${i}`);
                if (box) slab.cost = parseFloat(box.value);
              });
            
              ebSlabs.forEach(slab => {
                if (units >= slab.from) {
                  const used = Math.min(units, slab.to) - slab.from + 1;
                  if (used > 0) total += used * slab.cost;
                }
              });
            
              return total.toFixed(2);
            }
            byId("calcEbBtn").addEventListener("click", () => {

            const name = byId("ebConsumerName").value.trim();
            const oldR = parseFloat(byId("ebOldReading").value);
            const newR = parseFloat(byId("ebNewReading").value);
            const units = parseFloat(byId("ebConsumedUnits").value);
          
            if (isNaN(oldR) || isNaN(newR) || units <= 0) {
              alert("Enter valid readings");
              return;
            }
          
            const amount = calculateEbBill(units);
              // Show result
              byId("ebResult").innerHTML = `
              <div style="padding:10px;background:#f2f2f2;border-radius:6px;">
                <b>${name || "New Calculation"}</b><br>
                Old (${oldR}) - New (${newR}) = Units (${units})<br>
                Price: ‚Çπ${amount}
              </div>
            `;
              // -------------- SAVE TO HISTORY --------------
              appData.calculationHistory.push({
                type: name || "New Calculation",
                title: `Old(${oldR}) - New(${newR}) = Units(${units})`,
                value: `‚Çπ${amount}`,
                timestamp: new Date().toISOString()
              });
            
              saveAll();
              renderCalculationHistory();
            });
            function renderCalculationHistory() {
              const list = document.getElementById("calculationHistoryList");
              list.innerHTML = "";
            
              if (!appData.calculationHistory || appData.calculationHistory.length === 0) {
                list.innerHTML = `<li>No calculation history yet.</li>`;
                return;
              }
            
              appData.calculationHistory.forEach((h, index) => {
                const li = document.createElement("li");
            
                const type = h.type || "Calculation";        // fallback for old entries
                const title = h.title || h.input || "‚Äî";     // fallback for old entries
                const value = h.value || h.result || "‚Äî";    // fallback for old entries
                const time = h.timestamp || h.createdAt || ""; 
            
                const formattedDate = time 
                    ? new Date(time).toLocaleString()
                    : "";
            
                const left = document.createElement("div");
                left.className = "item-left";
            
                left.innerHTML = `
                  <div><b>${type}</b></div>
                  <div>${title}</div>
                  <div>${value}</div>
                  <small style="opacity:0.7;">${formattedDate}</small>
                `;
            
                const right = document.createElement("div");
                right.style.display = "flex";
                right.style.alignItems = "center";
            
                const editBtn = document.createElement("button");
                editBtn.className = "icon-small";
                editBtn.textContent = "‚úèÔ∏è";
                editBtn.onclick = () => editHistory(index);
            
                const delBtn = document.createElement("button");
                delBtn.className = "icon-small";
                delBtn.textContent = "üóëÔ∏è";
                delBtn.onclick = () => deleteHistory(index);
            
                right.appendChild(editBtn);
                right.appendChild(delBtn);
            
                li.appendChild(left);
                li.appendChild(right);
            
                list.appendChild(li);
              });
            }
            byId("ebNewReading").addEventListener("input", () => {
              const oldR = parseFloat(byId("ebOldReading").value) || 0;
              const newR = parseFloat(byId("ebNewReading").value) || 0;
              const units = newR - oldR;
              byId("ebConsumedUnits").value = units > 0 ? units : 0;
            });
            
            byId("ebOldReading").addEventListener("input", () => {
              const oldR = parseFloat(byId("ebOldReading").value) || 0;
              const newR = parseFloat(byId("ebNewReading").value) || 0;
              const units = newR - oldR;
              byId("ebConsumedUnits").value = units > 0 ? units : 0;
            });
              // ---------- End Initial Render Code ----------
              })();
    </script>
  </body>
</html>
